# 🚀 CI/CD Pipeline - Документация

## 📖 Содержание

- [Обзор](#-обзор)
- [Архитектура](#-архитектура)
- [Процесс разработки](#-процесс-разработки)
- [CI - Проверка кода](#-ci---проверка-кода)
- [CD - Автоматический деплой](#-cd---автоматический-деплой)
- [Настройка секретов](#-настройка-секретов)
- [Troubleshooting](#-troubleshooting)

---

## 🎯 Обзор

CI/CD (Continuous Integration / Continuous Deployment) — это практика автоматизации процессов сборки, тестирования и развёртывания приложения.

### Что это даёт команде:

| Преимущество | Описание |
|--------------|----------|
| ⚡ Скорость | Автоматический деплой за ~3 минуты |
| 🛡️ Надёжность | Код проверяется до мержа |
| 🔄 Консистентность | Одинаковый процесс для всех |
| 📊 Прозрачность | Видно статус каждой сборки |

---

## 🏗️ Архитектура

### Используемые инструменты

```
┌─────────────────────────────────────────────────────────────────┐
│                         ИНСТРУМЕНТЫ                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   GitHub Actions    →    Docker Hub    →    Timeweb VPS        │
│   (CI/CD runner)         (реестр           (сервер)            │
│                          образов)                               │
│                                                                 │
│   ┌─────────────┐      ┌─────────────┐    ┌─────────────┐      │
│   │  Запускает  │      │  Хранит     │    │  Запускает  │      │
│   │  проверки   │ ───▶ │  Docker     │ ──▶│  контейнеры │      │
│   │  и сборку   │      │  образы     │    │             │      │
│   └─────────────┘      └─────────────┘    └─────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Структура файлов

```
.github/
├── SECRETS.md              # Инструкция по секретам
└── workflows/
    ├── ci.yml              # Проверка кода при PR
    └── deploy.yml          # Деплой после мержа

frontend/
├── Dockerfile              # Сборка frontend образа
├── nginx.conf              # Конфиг веб-сервера
└── .dockerignore           # Исключения для Docker

backend/
├── Dockerfile              # Сборка backend образа
└── docker-compose.yml      # Локальный запуск
```

---

## 🔄 Процесс разработки

### Полная схема workflow

```
                              ┌─────────────────┐
                              │   Разработчик   │
                              │  создаёт ветку  │
                              │  feature/...    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │   Пишет код,    │
                              │    коммитит     │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  Открывает PR   │
                              │ в development   │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
                    ▼                                      │
           ┌───────────────┐                              │
           │   CI CHECKS   │                              │
           │   (ci.yml)    │                              │
           └───────┬───────┘                              │
                   │                                      │
          ┌────────┴────────┐                             │
          │                 │                             │
          ▼                 ▼                             │
    ┌───────────┐    ┌───────────┐                       │
    │  Frontend │    │  Backend  │                       │
    │   Check   │    │   Check   │                       │
    │           │    │           │                       │
    │ • ESLint  │    │ • Prisma  │                       │
    │ • TS Build│    │ • TS Build│                       │
    └─────┬─────┘    └─────┬─────┘                       │
          │                │                             │
          └────────┬───────┘                             │
                   │                                      │
          ┌────────┴────────┐                             │
          │                 │                             │
          ▼                 ▼                             │
     ✅ Passed         ❌ Failed                          │
          │                 │                             │
          │                 └──────────┐                  │
          │                            ▼                  │
          │                 ┌─────────────────┐          │
          │                 │  Разработчик    │          │
          │                 │  исправляет     │──────────┘
          │                 │  ошибки         │
          │                 └─────────────────┘
          │
          ▼
    ┌───────────────┐
    │  Code Review  │
    │  от команды   │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │    MERGE      │
    │ в development │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │    DEPLOY     │
    │ (deploy.yml)  │
    └───────┬───────┘
            │
    ┌───────┴───────┐
    │               │
    ▼               ▼
┌────────┐    ┌────────┐
│Backend │    │Frontend│
│ Build  │    │ Build  │
│& Push  │    │& Push  │
└───┬────┘    └───┬────┘
    │             │
    └──────┬──────┘
           │
           ▼
    ┌───────────────┐
    │  SSH Deploy   │
    │   to VPS      │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │  ✅ ГОТОВО!   │
    │  Приложение   │
    │  обновлено    │
    └───────────────┘
```

### Ветки и их назначение

```
┌─────────────────────────────────────────────────────────────────┐
│                        СТРУКТУРА ВЕТОК                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   master (main)                                                 │
│   ════════════════════════════════════════════▶                │
│   │                    ▲                                        │
│   │                    │ Merge (только Lead)                   │
│   │                    │                                        │
│   │   development                                               │
│   │   ════════════════════════════════════════▶                │
│   │        ▲      ▲      ▲                                     │
│   │        │      │      │ Merge PR                            │
│   │        │      │      │                                      │
│   │   ┌────┴──┐ ┌─┴───┐ ┌┴────┐                                │
│   │   │feat/1 │ │fix/2│ │feat/│                                │
│   │   └───────┘ └─────┘ └─────┘                                │
│   │   Feature branches                                         │
│   │                                                             │
└─────────────────────────────────────────────────────────────────┘

Легенда:
  master      = Стабильная версия (релизы)
  development = Рабочая ветка (CI/CD активен)
  feature/*   = Фичи разработчиков
  refactor/*  = Исправления багов
```

---

## 🔍 CI - Проверка кода

### Когда запускается

| Событие | CI запускается? |
|---------|-----------------|
| Создан PR в `development` | ✅ Да |
| Новый коммит в открытый PR | ✅ Да |
| PR закрыт без мержа | ❌ Нет |
| Пуш напрямую в `master` | ❌ Нет |

### Что проверяется

```
┌─────────────────────────────────────────────────────────────────┐
│                      CI PIPELINE (ci.yml)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    Frontend Check                        │  │
│   ├─────────────────────────────────────────────────────────┤  │
│   │  1. 📥 Checkout         - Скачивание кода               │  │
│   │  2. 📦 Setup Node.js    - Установка Node 20             │  │
│   │  3. 📚 npm ci           - Установка зависимостей        │  │
│   │  4. 🔍 ESLint           - Проверка код-стайла           │  │
│   │  5. 🔨 TypeScript Build - Проверка типизации            │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              │ Параллельно                      │
│                              │                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    Backend Check                         │  │
│   ├─────────────────────────────────────────────────────────┤  │
│   │  1. 📥 Checkout         - Скачивание кода               │  │
│   │  2. 📦 Setup Node.js    - Установка Node 20             │  │
│   │  3. 📚 npm ci           - Установка зависимостей        │  │
│   │  4. 🗄️ Prisma Generate  - Генерация клиента БД          │  │
│   │  5. 🔨 TypeScript Build - Проверка типизации            │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    CI Success                            │  │
│   │         Финальная проверка что всё прошло               │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Время выполнения

| Job | Примерное время |
|-----|-----------------|
| Frontend Check | ~45 сек |
| Backend Check | ~40 сек |
| **Общее время** | **~1 минута** |

---

## 🚀 CD - Автоматический деплой

### Когда запускается

| Событие | Deploy запускается? |
|---------|---------------------|
| PR смержен в `development` | ✅ Да |
| PR закрыт без мержа | ❌ Нет |
| Пуш напрямую в `development` | ❌ Нет |

### Этапы деплоя

```
┌─────────────────────────────────────────────────────────────────┐
│                    DEPLOY PIPELINE (deploy.yml)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  ЭТАП 1: Подготовка                                       │ │
│  │  ──────────────────                                       │ │
│  │  • Checkout кода из репозитория                          │ │
│  │  • Настройка Docker Buildx                               │ │
│  │  • Авторизация в Docker Hub                              │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  ЭТАП 2: Сборка Backend                                   │ │
│  │  ──────────────────────                                   │ │
│  │  • docker build ./backend                                │ │
│  │  • docker push → Docker Hub                              │ │
│  │  • Теги: latest, v{номер_сборки}                         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  ЭТАП 3: Сборка Frontend                                  │ │
│  │  ───────────────────────                                  │ │
│  │  • docker build ./frontend                               │ │
│  │  • Передача VITE_API_URL                                 │ │
│  │  • docker push → Docker Hub                              │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  ЭТАП 4: Деплой на сервер                                 │ │
│  │  ────────────────────────                                 │ │
│  │  • SSH подключение к VPS                                 │ │
│  │  • docker pull (скачивание образов)                      │ │
│  │  • Остановка старых контейнеров                          │ │
│  │  • Запуск новых контейнеров                              │ │
│  │  • Очистка неиспользуемых образов                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│                              ▼                                  │
│                    ✅ ДЕПЛОЙ ЗАВЕРШЁН                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Время выполнения

| Этап | Примерное время |
|------|-----------------|
| Подготовка | ~10 сек |
| Сборка Backend | ~1 мин |
| Сборка Frontend | ~1 мин |
| Деплой на сервер | ~30 сек |
| **Общее время** | **~3 минуты** |

---

## 🔐 Настройка секретов

### Где настроить

```
GitHub Repository
       │
       └── Settings
              │
              └── Secrets and variables
                         │
                         └── Actions
                                │
                                └── New repository secret
```

### Список секретов

```
┌─────────────────────────────────────────────────────────────────┐
│                      GITHUB SECRETS                             │
├─────────────────┬───────────────────────────────────────────────┤
│ Секрет          │ Описание                                      │
├─────────────────┼───────────────────────────────────────────────┤
│ DOCKER_USERNAME │ Логин на Docker Hub                          │
│ DOCKER_PASSWORD │ Access Token от Docker Hub                   │
│ TIMEWEB_HOST    │ IP адрес VPS сервера                         │
│ TIMEWEB_SSH_KEY │ Приватный SSH ключ для подключения           │
│ API_URL         │ URL бэкенда для фронтенда                    │
└─────────────────┴───────────────────────────────────────────────┘
```

### Файл окружения на сервере

На VPS должен существовать файл `/root/fitness-backend.env`:

```env
# База данных
DATABASE_URL=postgresql://user:password@host:5432/database
DIRECT_URL=postgresql://user:password@host:5432/database

# JWT
JWT_ACCESS_SECRET=your-super-secret-key-minimum-32-characters
COOKIE_SECRET=another-super-secret-key

# Окружение
NODE_ENV=production
FRONTEND_URL=https://your-domain.ru
```

---

## 🔧 Troubleshooting

### Где смотреть логи

```
GitHub → Repository → Actions → Выбрать workflow run → Выбрать job
```

### Частые ошибки

#### ❌ CI: ESLint errors

```
Причина: Код не соответствует правилам линтера
Решение: npm run lint --fix локально, закоммитить исправления
```

#### ❌ CI: TypeScript errors

```
Причина: Ошибки типизации
Решение: npm run build локально, исправить ошибки
```

#### ❌ Deploy: Docker login failed

```
Причина: Неверные DOCKER_USERNAME или DOCKER_PASSWORD
Решение: Проверить секреты в GitHub Settings
```

#### ❌ Deploy: SSH connection refused

```
Причина: Неверный TIMEWEB_HOST или TIMEWEB_SSH_KEY
Решение: 
  1. Проверить IP сервера
  2. Убедиться что публичный ключ добавлен в ~/.ssh/authorized_keys
```

#### ❌ Deploy: Container fails to start

```
Причина: Отсутствует или неверный /root/fitness-backend.env
Решение: Проверить файл на сервере: cat /root/fitness-backend.env
```

### Как перезапустить workflow

```
GitHub → Actions → Выбрать упавший run → "Re-run all jobs"
```

---

## 📚 Полезные ссылки

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Docker Documentation](https://docs.docker.com/)
- [Docker Hub](https://hub.docker.com/)

---

## 📝 История изменений

| Дата | Автор | Изменения |
|------|-------|-----------|
| 10.12.2025 | Колесников Дмитрий | Создание документации CI/CD |

