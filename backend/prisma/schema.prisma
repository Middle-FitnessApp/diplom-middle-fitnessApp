generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  CLIENT
  TRAINER
}

model User {
  // общие поля
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?  @unique
  password  String
  photo     String?  @default("/uploads/default/user.png")
  age       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  role      UserRole @default(CLIENT)

  // поля client
  goal         String?
  restrictions String?
  experience   String?
  diet         String?

  // поля trainer
  telegram  String?
  whatsapp  String?
  instagram String?
  bio       String?

  refreshTokens   RefreshToken[]
  progressReports Progress[]
  comments        Comment[]

  // связи тренер–клиент
  trainerClients TrainerClient[] @relation("TrainerClientsAsTrainer")
  asClientOf     TrainerClient[] @relation("TrainerClientsAsClient")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model Progress {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  // Обязательные измерения (по ТЗ)
  weight Float
  waist  Float
  hips   Float

  // Опциональные измерения
  height Float?
  chest  Float?
  arm    Float?
  leg    Float?

  // Фото отчета
  photoFront String?
  photoSide  String?
  photoBack  String?

  // Комментарий тренера
  trainerComment String?
  commentedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comment[]

  @@index([userId, date])
  @@index([userId, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())

  progressId String
  progress   Progress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  trainerId String
  trainer   User   @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([progressId])
  @@index([trainerId])
}

// Связь тренера и его клиента с флагом избранности
model TrainerClient {
  id        String   @id @default(cuid())
  trainer   User     @relation("TrainerClientsAsTrainer", fields: [trainerId], references: [id])
  trainerId String
  client    User     @relation("TrainerClientsAsClient", fields: [clientId], references: [id])
  clientId  String

  starred   Boolean  @default(false)
  createdAt DateTime @default(now())

  // Один клиент может быть только у одного тренера
  @@unique([clientId])
}
