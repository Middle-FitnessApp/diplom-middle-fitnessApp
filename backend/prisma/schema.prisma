generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  CLIENT
  TRAINER
}

// –¢–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
enum MealType {
  BREAKFAST
  SNACK
  LUNCH
  DINNER
}

model User {
  // –æ–±—â–∏–µ –ø–æ–ª—è
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?  @unique
  password  String
  photo     String?  @default("/uploads/default/user.png")
  age       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  role      UserRole @default(CLIENT)

  // –ø–æ–ª—è client
  goal         String?
  restrictions String?
  experience   String?
  diet         String?

  // –ø–æ–ª—è trainer
  telegram  String?
  whatsapp  String?
  instagram String?
  bio       String?

  refreshTokens   RefreshToken[]
  progressReports Progress[]
  comments        Comment[]

  // —Å–≤—è–∑–∏ —Ç—Ä–µ–Ω–µ—Ä‚Äì–∫–ª–∏–µ–Ω—Ç
  trainerClients TrainerClient[] @relation("TrainerClientsAsTrainer")
  asClientOf     TrainerClient[] @relation("TrainerClientsAsClient")

  // üîΩ —Å–≤—è–∑–∏ –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è
  nutritionCategories   NutritionCategory[]     @relation("UserNutritionCategories")
  assignedNutritionPlan AssignedNutritionPlan[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model Progress {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–ø–æ –¢–ó)
  weight Float
  waist  Float
  hips   Float

  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è
  height Float?
  chest  Float?
  arm    Float?
  leg    Float?

  // –§–æ—Ç–æ –æ—Ç—á–µ—Ç–∞
  photoFront String?
  photoSide  String?
  photoBack  String?

  // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ç—Ä–µ–Ω–µ—Ä–∞
  trainerComment String?
  commentedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comment[]

  @@index([userId, date])
  @@index([userId, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())

  progressId String
  progress   Progress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  trainerId String
  trainer   User   @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([progressId])
  @@index([trainerId])
}

// –°–≤—è–∑—å —Ç—Ä–µ–Ω–µ—Ä–∞ –∏ –µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ñ–ª–∞–≥–æ–º –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç–∏
model TrainerClient {
  id        String @id @default(cuid())
  trainer   User   @relation("TrainerClientsAsTrainer", fields: [trainerId], references: [id])
  trainerId String
  client    User   @relation("TrainerClientsAsClient", fields: [clientId], references: [id])
  clientId  String

  starred   Boolean  @default(false)
  createdAt DateTime @default(now())

  // –û–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —É –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞
  @@unique([clientId])
}

//
// ======= –ü–∏—Ç–∞–Ω–∏–µ =======
//

// –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–≥—Ä–∞–º–º –ø–∏—Ç–∞–Ω–∏—è
model NutritionCategory {
  id          String          @id @default(cuid())
  trainerId   String
  trainer     User            @relation("UserNutritionCategories", fields: [trainerId], references: [id], onDelete: Cascade)
  name        String          @unique
  description String?

  programs    NutritionProgram[]

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–∏—Ç–∞–Ω–∏—è
model NutritionProgram {
  id           String                @id @default(cuid())
  categoryId   String
  category     NutritionCategory     @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  name         String                @unique
  description  String?

  days         ProgramDay[]
  assignedPlans AssignedNutritionPlan[]

  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
}


// –î–µ–Ω—å –ø—Ä–æ–≥—Ä–∞–º–º—ã
model ProgramDay {
  id        String           @id @default(cuid())
  programId String
  program   NutritionProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  dayTitle String
  dayOrder Int

  meals Meal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// –ü—Ä–∏—ë–º –ø–∏—â–∏
model Meal {
  id    String     @id @default(cuid())
  dayId String
  day   ProgramDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  type      MealType
  name      String
  mealOrder Int

  items String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç—É –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è
model AssignedNutritionPlan {
  id       String @id @default(cuid())
  clientId String
  client   User   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  programId String
  program   NutritionProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–Ω—è–º–∏ ‚Äî –º–∞—Å—Å–∏–≤ ID
  dayIds String[]

  createdAt DateTime @default(now())
}
