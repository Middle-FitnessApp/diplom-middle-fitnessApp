generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  CLIENT
  TRAINER
}

// –¢–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
enum MealType {
  BREAKFAST
  SNACK
  LUNCH
  DINNER
}

model User {
  // –æ–±—â–∏–µ –ø–æ–ª—è
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?  @unique
  password  String
  photo     String?  @default("/uploads/default/user.png")
  age       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  role      UserRole @default(CLIENT)

  // –ø–æ–ª—è client
  goal         String?
  restrictions String?
  experience   String?
  diet         String?

  // –ø–æ–ª—è trainer
  telegram  String?
  whatsapp  String?
  instagram String?
  bio       String?

  refreshTokens   RefreshToken[]
  progressReports Progress[]
  comments        Comment[]

  // —Å–≤—è–∑–∏ —Ç—Ä–µ–Ω–µ—Ä‚Äì–∫–ª–∏–µ–Ω—Ç
  trainerClients TrainerClient[] @relation("TrainerClientsAsTrainer")
  asClientOf     TrainerClient[] @relation("TrainerClientsAsClient")

  // üîΩ —Å–≤—è–∑–∏ –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è
  nutritionCategories  NutritionCategory[]   @relation("UserNutritionCategories")
  clientNutritionPlans ClientNutritionPlan[]

  // üîΩ —Å–≤—è–∑–∏ –¥–ª—è —á–∞—Ç–∞
  chatsAsTrainer Chat[]    @relation("ChatTrainer")
  chatsAsClient  Chat[]    @relation("ChatClient")
  messages       Message[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model Progress {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–ø–æ –¢–ó)
  weight Float
  waist  Float
  hips   Float

  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è
  height Float?
  chest  Float?
  arm    Float?
  leg    Float?

  // –§–æ—Ç–æ –æ—Ç—á–µ—Ç–∞
  photoFront String?
  photoSide  String?
  photoBack  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comment[]

  @@index([userId, date])
  @@index([userId, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())

  progressId String
  progress   Progress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  trainerId String
  trainer   User   @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([progressId])
  @@index([trainerId])
}

// –°—Ç–∞—Ç—É—Å—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π —Ç—Ä–µ–Ω–µ—Ä-–∫–ª–∏–µ–Ω—Ç
enum TrainerClientStatus {
  PENDING // –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ, –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞
  ACCEPTED // –¢—Ä–µ–Ω–µ—Ä –ø—Ä–∏–Ω—è–ª, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º
  REJECTED // –¢—Ä–µ–Ω–µ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
}

// –°–≤—è–∑—å —Ç—Ä–µ–Ω–µ—Ä–∞ –∏ –µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
model TrainerClient {
  id        String @id @default(cuid())
  trainer   User   @relation("TrainerClientsAsTrainer", fields: [trainerId], references: [id], onDelete: Cascade)
  trainerId String
  client    User   @relation("TrainerClientsAsClient", fields: [clientId], references: [id], onDelete: Cascade)
  clientId  String

  // –°—Ç–∞—Ç—É—Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
  status TrainerClientStatus @default(PENDING)

  // –§–ª–∞–≥ –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è ACCEPTED)
  isFavorite Boolean @default(false)

  createdAt  DateTime  @default(now())
  acceptedAt DateTime? // –ö–æ–≥–¥–∞ —Ç—Ä–µ–Ω–µ—Ä –ø—Ä–∏–Ω—è–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ

  // –û–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  @@unique([clientId, trainerId])
  @@index([clientId])
  @@index([trainerId])
  @@index([status])
}

//
// ======= –ü–∏—Ç–∞–Ω–∏–µ =======
//

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
model NutritionCategory {
  id          String  @id @default(cuid())
  trainerId   String
  trainer     User    @relation("UserNutritionCategories", fields: [trainerId], references: [id], onDelete: Cascade)
  name        String  @unique
  description String?

  subcategories NutritionSubcategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–±—ã–≤—à–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã)
model NutritionSubcategory {
  id         String            @id @default(cuid())
  categoryId String
  category   NutritionCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  name        String  @unique
  description String?

  days        NutritionDay[]
  clientPlans ClientNutritionPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// –ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å
model NutritionDay {
  id          String               @id @default(cuid())
  subcatId    String
  subcategory NutritionSubcategory @relation(fields: [subcatId], references: [id], onDelete: Cascade)

  dayTitle String
  dayOrder Int

  meals NutritionMeal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// –ü—Ä–∏—ë–º –ø–∏—â–∏
model NutritionMeal {
  id    String       @id @default(cuid())
  dayId String
  day   NutritionDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  type      MealType
  name      String
  mealOrder Int

  items String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç—É –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è
model ClientNutritionPlan {
  id       String @id @default(cuid())
  clientId String
  client   User   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  subcatId    String
  subcategory NutritionSubcategory @relation(fields: [subcatId], references: [id], onDelete: Cascade)

  // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–Ω—è–º–∏ ‚Äî –º–∞—Å—Å–∏–≤ ID
  dayIds String[]

  // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–ª–∞–Ω–∞ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è —Ü–∏–∫–ª–∞)
  startDate DateTime @default(now())

  // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–ª–∞–Ω (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ======= –ß–∞—Ç =======
//

model Chat {
  id        String   @id @default(cuid())
  trainerId String
  trainer   User     @relation("ChatTrainer", fields: [trainerId], references: [id], onDelete: Cascade)
  clientId  String
  client    User     @relation("ChatClient", fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@unique([trainerId, clientId])
  @@index([trainerId])
  @@index([clientId])
}

model Message {
  id        String   @id @default(cuid())
  chatId    String
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  senderId  String
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  text      String
  imageUrl  String?
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)

  @@index([chatId])
  @@index([senderId])
}
