# Trainer API - Документация

API для работы с тренерами и управления клиентами.

**Base URL:** `/api/trainer`

---

## Оглавление

- [Получение всех тренеров](#получение-всех-тренеров)
- [Получение профиля конкретного тренера](#получение-профиля-конкретного-тренера)
- [Получение приглашений для тренера](#получение-приглашений-для-тренера)
- [Принятие приглашения от клиента](#принятие-приглашения-от-клиента)
- [Отклонение приглашения от клиента](#отклонение-приглашения-от-клиента)
- [Получение клиентов тренера](#получение-клиентов-тренера)
- [Просмотр профиля клиента тренером](#просмотр-профиля-клиента-тренером)
- [Добавить/убрать клиента в избранное](#добавитьубрать-клиента-в-избранное)
- [Назначение плана питания клиенту](#назначение-плана-питания-клиенту)

---

## Получение всех тренеров

Получает список всех зарегистрированных тренеров. Для авторизованных клиентов также возвращаются статусы приглашений.

**Endpoint:** `GET /api/trainer/all`

**Права доступа:** `PUBLIC` (авторизация опциональна)

**Headers (опционально):**

```
Authorization: Bearer <access_token>
```

### Примеры запросов

**Без авторизации:**

```bash
curl -X GET http://localhost:3000/api/trainer/all
```

**С авторизацией (CLIENT):**

```bash
curl -X GET http://localhost:3000/api/trainer/all \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

**Для неавторизованного пользователя или тренера:**

```json
{
	"trainers": [
		{
			"id": "cm4xyz789ghi012",
			"name": "Алексей Смирнов",
			"photo": "/uploads/photos/trainer1.jpg",
			"bio": "Сертифицированный тренер с 10-летним опытом",
			"telegram": "@alextrainer",
			"whatsapp": "+79997654321",
			"instagram": "alex_fitness"
		},
		{
			"id": "cm4def456jkl789",
			"name": "Мария Иванова",
			"photo": "/uploads/photos/trainer2.jpg",
			"bio": "Специалист по йоге и стретчингу",
			"telegram": "@maria_yoga",
			"whatsapp": null,
			"instagram": "maria_yoga_pro"
		}
	]
}
```

**Для авторизованного клиента (с информацией о приглашениях):**

```json
{
	"trainers": [
		{
			"id": "cm4xyz789ghi012",
			"name": "Алексей Смирнов",
			"photo": "/uploads/photos/trainer1.jpg",
			"bio": "Сертифицированный тренер с 10-летним опытом",
			"telegram": "@alextrainer",
			"whatsapp": "+79997654321",
			"instagram": "alex_fitness",
			"inviteStatus": "PENDING"
		},
		{
			"id": "cm4def456jkl789",
			"name": "Мария Иванова",
			"photo": "/uploads/photos/trainer2.jpg",
			"bio": "Специалист по йоге и стретчингу",
			"telegram": "@maria_yoga",
			"whatsapp": null,
			"instagram": "maria_yoga_pro",
			"inviteStatus": null
		}
	]
}
```

### Описание полей ответа

**Базовые поля (для всех пользователей):**

- `id` - уникальный идентификатор тренера
- `name` - имя тренера
- `photo` - путь к фото профиля
- `bio` - биография тренера
- `telegram` - username в Telegram (может быть `null`)
- `whatsapp` - номер WhatsApp (может быть `null`)
- `instagram` - username в Instagram (может быть `null`)

**Дополнительные поля (только для авторизованных клиентов):**

- `inviteStatus` - статус приглашения от клиента к этому тренеру:
  - `"PENDING"` - приглашение отправлено, ожидает ответа
  - `"ACCEPTED"` - приглашение принято (это текущий тренер клиента)
  - `"REJECTED"` - приглашение отклонено тренером
  - `null` - приглашение не отправлялось

### Логика работы

1. **Без авторизации:**

   - Возвращается только базовая публичная информация о тренерах
   - Поле `inviteStatus` отсутствует

2. **С авторизацией (CLIENT):**

   - Возвращается базовая информация + статусы приглашений
   - Для каждого тренера проверяется наличие записи в `TrainerClient`
   - Если запись существует - возвращается её статус
   - Если записи нет - `inviteStatus: null`

3. **С авторизацией (TRAINER):**
   - Тренеры не получают дополнительные поля
   - Возвращается только базовая информация

### Сортировка

Тренеры отсортированы по имени в алфавитном порядке.

### Примечания

- Эндпоинт **публичный** - не требует обязательной авторизации
- Авторизация опциональна и влияет только на наличие `inviteStatus`
- Невалидный токен игнорируется - эндпоинт продолжает работу как публичный
- Email и телефон тренеров **не возвращаются** для защиты приватности
- Используется для отображения списка тренеров на главной странице клиента

---

## Получение профиля конкретного тренера

Получает полную информацию о конкретном тренере. Если пользователь авторизован как клиент, добавляются дополнительные поля о статусе приглашения.

**Endpoint:** `GET /api/trainer/:id`

**Права доступа:** `PUBLIC` (авторизация опциональна)

**Headers (опционально):**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание          |
| -------- | ------ | ----------------- |
| id       | string | ID тренера (CUID) |

### Примеры запросов

**Без авторизации:**

```bash
curl -X GET http://localhost:3000/api/trainer/cm4xyz789ghi012
```

**С авторизацией (CLIENT):**

```bash
curl -X GET http://localhost:3000/api/trainer/cm4xyz789ghi012 \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

**Для неавторизованного пользователя:**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z"
	}
}
```

**Для авторизованного клиента (без приглашения):**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"inviteStatus": null,
		"isMyTrainer": false
	}
}
```

**Для авторизованного клиента (с приглашением PENDING):**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"inviteStatus": "PENDING",
		"isMyTrainer": false
	}
}
```

**Для авторизованного клиента (с приглашением ACCEPTED):**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"inviteStatus": "ACCEPTED",
		"isMyTrainer": true
	}
}
```

### Описание полей ответа

**Базовые поля (для всех пользователей):**

- `id` - уникальный идентификатор тренера
- `name` - имя тренера
- `photo` - путь к фото профиля
- `age` - возраст тренера
- `bio` - биография и специализация
- `telegram` - username в Telegram (может быть `null`)
- `whatsapp` - номер WhatsApp (может быть `null`)
- `instagram` - username в Instagram (может быть `null`)
- `createdAt` - дата регистрации тренера

**Дополнительные поля (только для авторизованных клиентов):**

- `inviteStatus` - статус приглашения (`PENDING` | `ACCEPTED` | `REJECTED` | `null`)
- `isMyTrainer` - `true` если это текущий тренер клиента (статус `ACCEPTED`), иначе `false`

### Логика работы

1. **Без авторизации:**

   - Возвращается только базовая публичная информация
   - Поля `inviteStatus` и `isMyTrainer` отсутствуют

2. **С авторизацией (CLIENT):**

   - Проверяется наличие связи `TrainerClient` между клиентом и тренером
   - Если связь существует - возвращается её статус
   - Если связи нет - `inviteStatus: null`, `isMyTrainer: false`

3. **С авторизацией (TRAINER):**
   - Тренеры не получают дополнительные поля
   - Возвращается только базовая информация

### Ошибки

- **404 Not Found** - Тренер не найден или пользователь не является тренером

### Примечания

- Эндпоинт **публичный** - не требует обязательной авторизации
- Авторизация опциональна и влияет только на наличие дополнительных полей
- Невалидный токен игнорируется - эндпоинт продолжает работу как публичный
- Email и телефон тренера **не возвращаются** для защиты приватности

---

## Получение приглашений для тренера

Получает список клиентов, отправивших приглашения тренеру. Поддерживает фильтрацию по статусу и пагинацию.

**Endpoint:** `GET /api/trainer/invites`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Query параметры

| Параметр | Тип    | По умолчанию | Описание                                              |
| -------- | ------ | ------------ | ----------------------------------------------------- |
| status   | string | `PENDING`    | Статус приглашений: `PENDING`, `ACCEPTED`, `REJECTED` |
| page     | number | `1`          | Номер страницы (минимум 1)                            |
| limit    | number | `10`         | Количество элементов на странице (от 1 до 100)        |

### Примеры запросов

**Получить ожидающие приглашения (по умолчанию):**

```bash
curl -X GET http://localhost:3000/api/trainer/invites \
  -H "Authorization: Bearer <access_token>"
```

**Получить принятые приглашения (текущие клиенты):**

```bash
curl -X GET "http://localhost:3000/api/trainer/invites?status=ACCEPTED" \
  -H "Authorization: Bearer <access_token>"
```

**Получить отклоненные приглашения со второй страницы:**

```bash
curl -X GET "http://localhost:3000/api/trainer/invites?status=REJECTED&page=2&limit=20" \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"invites": [
		{
			"id": "cm4xyz123abc456",
			"status": "PENDING",
			"createdAt": "2024-12-01T10:00:00.000Z",
			"client": {
				"id": "cm4abc789def012",
				"name": "Анна Смирнова",
				"photo": "/uploads/photos/client1.jpg",
				"age": 25,
				"goal": "Похудение"
			}
		},
		{
			"id": "cm4def456ghi789",
			"status": "PENDING",
			"createdAt": "2024-12-01T09:30:00.000Z",
			"client": {
				"id": "cm4ghi012jkl345",
				"name": "Иван Петров",
				"photo": null,
				"age": 30,
				"goal": "Набор мышечной массы"
			}
		}
	]
}
```

### Описание полей ответа

- `id` - уникальный идентификатор приглашения (TrainerClient.id)
- `status` - статус приглашения (`PENDING` | `ACCEPTED` | `REJECTED`)
- `createdAt` - дата отправки приглашения
- `client` - информация о клиенте:
  - `id` - ID клиента
  - `name` - имя клиента
  - `photo` - фото профиля (может быть `null`)
  - `age` - возраст клиента
  - `goal` - цель тренировок (может быть `null`)

### Сортировка

Приглашения отсортированы по дате создания в обратном порядке (новые первыми).

### Пагинация

Пример использования:

- `page=1&limit=10` - первые 10 приглашений
- `page=2&limit=10` - приглашения с 11 по 20
- `page=3&limit=20` - приглашения с 41 по 60

### Примечания

- По умолчанию возвращаются только **PENDING** приглашения (ожидающие ответа)
- Для просмотра текущих клиентов используйте `status=ACCEPTED`
- Максимальный лимит на странице - 100 элементов
- Если приглашений нет - возвращается пустой массив `[]`

### Ошибки

- **400 Bad Request** - Некорректные query параметры (неверный статус, page < 1, limit вне диапазона)
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров

---

## Принятие приглашения от клиента

Тренер принимает приглашение от клиента, устанавливает связь и автоматически отклоняет все остальные приглашения этого клиента.

**Endpoint:** `POST /api/trainer/invites/:id/accept`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание              |
| -------- | ------ | --------------------- |
| id       | string | ID приглашения (CUID) |

### Примеры запросов

```bash
curl -X POST http://localhost:3000/api/trainer/invites/cm4xyz123abc456/accept \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"message": "Вы приняли клиента в работу",
	"client": {
		"id": "cm4abc789def012",
		"name": "Анна Смирнова",
		"photo": "/uploads/photos/client1.jpg",
		"isFavorite": false
	}
}
```

### Описание полей ответа

- `message` - подтверждающее сообщение
- `client` - информация о принятом клиенте:
  - `id` - ID клиента
  - `name` - имя клиента
  - `photo` - фото профиля (может быть `null`)
  - `isFavorite` - флаг избранного (по умолчанию `false`)

### Логика работы

1. **Проверка приглашения:**

   - Приглашение должно существовать
   - Должно быть предназначено текущему тренеру
   - Должно быть в статусе `PENDING`

2. **Проверка клиента:**

   - У клиента НЕ должно быть активного тренера (другой связи со статусом `ACCEPTED`)
   - Если есть → возвращается ошибка 409 Conflict

3. **Принятие приглашения (транзакция):**
   - Текущее приглашение: статус → `ACCEPTED`, устанавливается `acceptedAt`
   - Все остальные приглашения этого клиента: статус → `REJECTED`
   - Гарантируется атомарность операции

### Ошибки

**400 Bad Request** - Приглашение уже обработано

```json
{
	"statusCode": 400,
	"message": "Приглашение уже обработано"
}
```

**403 Forbidden** - Приглашение предназначено другому тренеру

```json
{
	"statusCode": 403,
	"message": "Это приглашение предназначено другому тренеру"
}
```

**404 Not Found** - Приглашение не найдено

```json
{
	"statusCode": 404,
	"message": "Приглашение не найдено"
}
```

**409 Conflict** - Клиент уже работает с другим тренером

```json
{
	"statusCode": 409,
	"message": "Клиент уже работает с другим тренером"
}
```

### Примечания

- После принятия приглашения у клиента может быть только **один активный тренер**
- Все остальные PENDING приглашения клиента автоматически отклоняются
- Операция выполняется в транзакции для обеспечения целостности данных
- Флаг `isFavorite` по умолчанию `false`, тренер может изменить его позже

---

## Отклонение приглашения от клиента

Тренер отклоняет приглашение от клиента. Клиент сможет повторно отправить приглашение позже.

**Endpoint:** `POST /api/trainer/invites/:id/reject`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание              |
| -------- | ------ | --------------------- |
| id       | string | ID приглашения (CUID) |

### Примеры запросов

```bash
curl -X POST http://localhost:3000/api/trainer/invites/cm4xyz123abc456/reject \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"message": "Приглашение отклонено"
}
```

### Логика работы

1. **Проверка приглашения:**

   - Приглашение должно существовать
   - Должно быть предназначено текущему тренеру
   - Должно быть в статусе `PENDING`

2. **Отклонение:**
   - Статус приглашения изменяется на `REJECTED`
   - Клиент может повторно отправить приглашение этому же тренеру позже

### Ошибки

**400 Bad Request** - Приглашение уже обработано

```json
{
	"statusCode": 400,
	"message": "Приглашение уже обработано"
}
```

**403 Forbidden** - Приглашение предназначено другому тренеру

```json
{
	"statusCode": 403,
	"message": "Это приглашение предназначено другому тренеру"
}
```

**404 Not Found** - Приглашение не найдено

```json
{
	"statusCode": 404,
	"message": "Приглашение не найдено"
}
```

### Примечания

- После отклонения клиент может отправить новое приглашение
- Отклонение не влияет на другие приглашения клиента к другим тренерам
- Операция простая и не требует транзакции

---

## Получение клиентов тренера

Получает список клиентов тренера в работе (со статусом ACCEPTED) с возможностью фильтрации и поиска.

**Endpoint:** `GET /api/trainer/clients`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Query параметры

| Параметр  | Тип     | По умолчанию | Описание                                                 |
| --------- | ------- | ------------ | -------------------------------------------------------- |
| favorites | boolean | -            | Фильтр по избранным клиентам (`true` - только избранные) |
| search    | string  | -            | Поиск по имени клиента (регистронезависимый)             |
| page      | number  | `1`          | Номер страницы (минимум 1)                               |
| limit     | number  | `10`         | Количество элементов на странице (от 1 до 100)           |

### Примеры запросов

**Все клиенты в работе (по умолчанию):**

```bash
curl -X GET http://localhost:3000/api/trainer/clients \
  -H "Authorization: Bearer <access_token>"
```

**Только избранные клиенты:**

```bash
curl -X GET "http://localhost:3000/api/trainer/clients?favorites=true" \
  -H "Authorization: Bearer <access_token>"
```

**Поиск по имени:**

```bash
curl -X GET "http://localhost:3000/api/trainer/clients?search=Иван" \
  -H "Authorization: Bearer <access_token>"
```

**Избранные с поиском и пагинацией:**

```bash
curl -X GET "http://localhost:3000/api/trainer/clients?favorites=true&search=Мария&page=1&limit=20" \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"clients": [
		{
			"id": "cm4abc123def456",
			"email": "ivan@example.com",
			"name": "Иван Петров",
			"age": 25,
			"phone": "+79991234567",
			"photo": "/uploads/photos/client1.jpg",
			"role": "CLIENT",
			"isFavorite": true
		},
		{
			"id": "cm4ghi789jkl012",
			"email": "maria@example.com",
			"name": "Мария Сидорова",
			"age": 30,
			"phone": "+79997654321",
			"photo": "/uploads/default/user.png",
			"role": "CLIENT",
			"isFavorite": false
		}
	]
}
```

### Описание полей ответа

- `id` - уникальный идентификатор клиента
- `email` - email клиента
- `name` - имя клиента
- `age` - возраст
- `phone` - номер телефона
- `photo` - путь к фото профиля
- `role` - роль (всегда `CLIENT`)
- `isFavorite` - `true` если клиент в избранном у этого тренера, `false` если нет

### Логика работы

1. **Фильтрация по статусу:**

   - Возвращаются только клиенты со статусом `ACCEPTED` (принятые в работу)
   - Автоматически исключаются клиенты с `PENDING` или `REJECTED`

2. **Фильтр по избранным:**

   - Без параметра - все клиенты в работе
   - `favorites=true` - только клиенты с `isFavorite: true`

3. **Поиск по имени:**

   - Регистронезависимый поиск
   - Поиск по вхождению подстроки в имя

4. **Сортировка:**

   - Клиенты отсортированы по имени (A-Z)

5. **Пагинация:**
   - `page=1&limit=10` - первые 10 клиентов
   - `page=2&limit=20` - клиенты с 21 по 40

### Примечания

- Возвращаются **только клиенты в работе** (со статусом `ACCEPTED`)
- Поиск работает по частичному совпадению в имени
- Максимальный лимит на странице - 100 элементов
- Если клиентов нет - возвращается пустой массив `[]`

### Ошибки

- **400 Bad Request** - Некорректные query параметры
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров

---

## Просмотр профиля клиента тренером

Получение полной информации о клиенте, включая последний отчет о прогрессе, статистику и назначенные планы питания.

**Endpoint:** `GET /api/trainer/clients/:id`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание          |
| -------- | ------ | ----------------- |
| id       | string | ID клиента (CUID) |

### Примеры запросов

```bash
# Получить полную информацию о клиенте
curl -X GET http://localhost:3000/api/trainer/clients/cm4abc123def456 \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"client": {
		"id": "cm4abc123def456",
		"name": "Иван Петров",
		"email": "client1@mail.ru",
		"phone": "+79161234567",
		"photo": "/uploads/photos/client1.jpg",
		"age": 28,
		"goal": "Похудение и набор мышечной массы",
		"restrictions": "Аллергия на молочные продукты",
		"experience": "Средний уровень подготовки",
		"diet": "Средиземноморская диета",
		"createdAt": "2024-11-01T10:00:00.000Z"
	},
	"lastProgress": {
		"id": "cm4xyz789ghi012",
		"date": "2024-12-05T08:30:00.000Z",
		"weight": 82.5,
		"waist": 85.0,
		"hips": 102.0,
		"height": 178.0,
		"chest": 98.0,
		"arm": 35.0,
		"leg": 58.0,
		"photoFront": "/uploads/photos/progress_front_123.jpg",
		"photoSide": "/uploads/photos/progress_side_123.jpg",
		"photoBack": "/uploads/photos/progress_back_123.jpg",
		"createdAt": "2024-12-05T08:30:00.000Z"
	},
	"statistics": {
		"totalReports": 12,
		"dynamics": {
			"weightChange": -5.2,
			"waistChange": -3.5,
			"hipsChange": -2.8,
			"periodDays": 45
		}
	},
	"nutritionPlans": [
		{
			"id": "cm4plan123abc456",
			"categoryName": "Набор массы",
			"subcategoryName": "Для мужчин 80-90кг",
			"subcategoryDescription": "План питания для набора мышечной массы",
			"assignedDays": ["cm4day1", "cm4day2", "cm4day3"],
			"assignedAt": "2024-11-15T12:00:00.000Z"
		}
	]
}
```

### Описание полей ответа

#### client (Информация о клиенте)

- `id` - уникальный идентификатор клиента
- `name` - имя клиента
- `email` - email клиента
- `phone` - номер телефона
- `photo` - путь к фото профиля
- `age` - возраст
- `goal` - цель тренировок (может быть `null`)
- `restrictions` - ограничения по здоровью (может быть `null`)
- `experience` - уровень опыта (может быть `null`)
- `diet` - тип диеты (может быть `null`)
- `createdAt` - дата регистрации

#### lastProgress (Последний отчет о прогрессе)

- `id` - ID отчета
- `date` - дата отчета
- `weight` - вес (кг)
- `waist` - талия (см)
- `hips` - бедра (см)
- `height` - рост (см, опционально)
- `chest` - грудь (см, опционально)
- `arm` - объем руки (см, опционально)
- `leg` - объем ноги (см, опционально)
- `photoFront` - фото спереди (опционально)
- `photoSide` - фото сбоку (опционально)
- `photoBack` - фото сзади (опционально)
- `createdAt` - дата создания отчета

**Примечание:** Если у клиента нет отчетов, `lastProgress` будет `null`.

#### statistics (Статистика)

- `totalReports` - общее количество отчетов о прогрессе
- `dynamics` - динамика изменений (может быть `null` если меньше 2 отчетов):
  - `weightChange` - изменение веса (кг)
  - `waistChange` - изменение талии (см)
  - `hipsChange` - изменение бедер (см)
  - `periodDays` - период наблюдения в днях

**Динамика рассчитывается как:** `последний отчет - первый отчет`

Положительные значения = увеличение, отрицательные = уменьшение.

#### nutritionPlans (Назначенные планы питания)

Массив назначенных клиенту планов питания:

- `id` - ID назначения плана
- `categoryName` - название категории питания
- `subcategoryName` - название подкатегории (программы)
- `subcategoryDescription` - описание программы
- `assignedDays` - массив ID назначенных дней
- `assignedAt` - дата назначения плана

**Примечание:** Если планов нет, массив будет пустым `[]`.

### Логика работы

1. **Проверка доступа:**

   - Проверяется связь между тренером и клиентом в таблице `TrainerClient`
   - Статус связи должен быть `ACCEPTED`
   - Если связь не найдена или статус другой → ошибка 403

2. **Получение данных клиента:**

   - Извлекается полная информация профиля клиента
   - Роль должна быть `CLIENT`

3. **Последний отчет:**

   - Запрашивается последний отчет, отсортированный по дате создания
   - Если отчетов нет → `lastProgress: null`

4. **Статистика:**

   - Подсчитывается общее количество отчетов
   - Если отчетов больше 1, рассчитывается динамика

5. **Планы питания:**
   - Извлекаются все назначенные клиенту планы
   - Сортируются по дате назначения (новые первыми)

### Ошибки

**401 Unauthorized** - Отсутствует или недействителен access token

```json
{
	"statusCode": 401,
	"message": "Unauthorized"
}
```

**403 Forbidden** - Вы не работаете с этим клиентом

```json
{
	"statusCode": 403,
	"message": "Вы не работаете с этим клиентом"
}
```

**404 Not Found** - Клиент не найден

```json
{
	"statusCode": 404,
	"message": "Клиент не найден"
}
```

### Примечания

- Эндпоинт доступен **только тренерам**, работающим с данным клиентом
- Возвращается **полная информация** о клиенте, включая приватные данные
- Динамика рассчитывается автоматически при наличии минимум 2 отчетов
- Все фотографии возвращаются как пути к файлам (локальное хранилище или Supabase URL)
- Отчеты о прогрессе упорядочены по дате создания (последние первыми)

---

## Добавить/убрать клиента в избранное

Переключает статус "избранное" для клиента (toggle).

**Endpoint:** `PUT /api/trainer/clients/:id/favorite`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание          |
| -------- | ------ | ----------------- |
| id       | string | ID клиента (CUID) |

### Примеры запросов

```bash
# Добавить/убрать клиента в избранное
curl -X PUT http://localhost:3000/api/trainer/clients/cm4abc123def456/favorite \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

**Когда клиент добавлен в избранное:**

```json
{
	"message": "Клиент добавлен в избранное",
	"isFavorite": true
}
```

**Когда клиент убран из избранного:**

```json
{
	"message": "Клиент убран из избранного",
	"isFavorite": false
}
```

### Описание полей ответа

- `isFavorite` - новый статус избранного (`true` - добавлен, `false` - убран)
- `message` - подтверждающее сообщение о действии

### Логика работы

Эндпоинт работает как переключатель (toggle):

1. **Проверка связи:**

   - Должна существовать связь `TrainerClient` между тренером и клиентом
   - Статус связи должен быть `ACCEPTED` (клиент в работе)
   - Если связи нет → ошибка 404
   - Если статус не `ACCEPTED` → ошибка 403

2. **Переключение флага:**

   - Если `isFavorite: false` → переключается на `true`
   - Если `isFavorite: true` → переключается на `false`

3. **Возврат результата:**
   - Возвращается новый статус и поясняющее сообщение

### Ошибки

**400 Bad Request** - Некорректный формат ID клиента

```json
{
	"statusCode": 400,
	"message": "ID клиента обязателен"
}
```

**401 Unauthorized** - Отсутствует или недействителен access token

```json
{
	"statusCode": 401,
	"message": "Unauthorized"
}
```

**403 Forbidden** - Вы не работаете с этим клиентом

```json
{
	"statusCode": 403,
	"message": "Вы не работаете с этим клиентом"
}
```

**404 Not Found** - Клиент не найден

```json
{
	"statusCode": 404,
	"message": "Клиент не найден"
}
```

### Примечания

- Эндпоинт доступен **только тренерам**, работающим с данным клиентом (статус `ACCEPTED`)
- Тренер **не может** добавить в избранное клиента, который не работает с ним
- Флаг избранного - локальная функция тренера, не влияет на клиента
- Используется для удобной фильтрации клиентов в списке

---

## Модель TrainerClient

Связь между тренером и клиентом с системой приглашений.

### Структура модели

```typescript
{
	id: string // CUID
	trainerId: string // ID тренера
	clientId: string // ID клиента
	status: TrainerClientStatus // Статус приглашения
	isFavorite: boolean // Избранный клиент
	acceptedAt: Date | null // Дата принятия приглашения
	createdAt: Date // Дата создания связи
	updatedAt: Date // Дата обновления
}
```

### Статусы приглашений (TrainerClientStatus)

| Статус   | Описание                               |
| -------- | -------------------------------------- |
| PENDING  | Приглашение отправлено, ожидает ответа |
| ACCEPTED | Приглашение принято тренером           |
| REJECTED | Приглашение отклонено тренером         |

### Правила работы системы приглашений

1. **Клиент отправляет приглашения:**

   - Может отправить приглашения нескольким тренерам
   - Все приглашения создаются со статусом `PENDING`

2. **Тренер принимает приглашение:**

   - Статус меняется на `ACCEPTED`
   - Устанавливается `acceptedAt` (текущая дата)
   - **Все остальные приглашения от этого клиента автоматически отклоняются** (статус `REJECTED`)

3. **Тренер отклоняет приглашение:**

   - Статус меняется на `REJECTED`
   - Клиент может найти другого тренера

4. **Ограничение:**
   - У клиента может быть только **один активный тренер** (одна связь со статусом `ACCEPTED`)

### Unique Constraint

Модель имеет составной уникальный ключ:

```prisma
@@unique([clientId, trainerId])
```

Это означает, что:

- Один клиент не может отправить несколько приглашений одному тренеру
- Уникальность проверяется по паре `(clientId, trainerId)`

---

## Примечания

### Текущая реализация

На данный момент реализованы эндпоинты:

- ✅ Просмотр всех тренеров (PUBLIC)
- ✅ Просмотр клиентов тренера
- ✅ Добавление/удаление клиентов в избранное

### В разработке (EPIC 4)

Система приглашений (12 задач):

- 4.2: Просмотр профиля конкретного тренера
- 4.3: Отправка приглашения тренеру от клиента
- 4.4: Получение списка приглашений для тренера
- 4.5: Принятие приглашения
- 4.6: Отклонение приглашения
- 4.7-4.12: Дополнительные функции

---

## Назначение плана питания клиенту

Тренер может назначить клиенту план питания из своих подкатегорий.

**Endpoint:** `POST /api/trainer/clients/:id/nutrition`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
Content-Type: application/json
```

### Параметры URL

| Параметр | Тип    | Описание   |
| -------- | ------ | ---------- |
| id       | string | ID клиента |

### Параметры тела запроса

| Поле          | Тип      | Обязательное | Описание                                                            |
| ------------- | -------- | ------------ | ------------------------------------------------------------------- |
| subcategoryId | string   | ✅           | ID подкатегории плана питания (должна принадлежать тренеру)         |
| dayIds        | string[] | ❌           | Массив ID конкретных дней для назначения (если не указан - все дни) |

### Примеры запросов

**Назначить все дни из подкатегории:**

```json
{
	"subcategoryId": "cm4abc123def456"
}
```

**Назначить конкретные дни:**

```json
{
	"subcategoryId": "cm4abc123def456",
	"dayIds": ["cm4day001", "cm4day002", "cm4day003"]
}
```

### Успешный ответ (201 Created)

```json
{
	"message": "План питания успешно назначен клиенту",
	"plan": {
		"id": "cm4plan123",
		"client": {
			"id": "cm4client001",
			"name": "Иван Иванов",
			"email": "client@mail.ru",
			"phone": "+79161234567"
		},
		"category": "Набор массы",
		"subcategory": {
			"id": "cm4subcat123",
			"name": "Для мужчин 80-90кг",
			"description": "План питания для набора мышечной массы"
		},
		"assignedDays": ["cm4day001", "cm4day002", "cm4day003"],
		"assignedAt": "2025-12-06T10:30:00.000Z"
	}
}
```

### Ошибки

**400 Bad Request** - Некорректные данные:

```json
{
	"statusCode": 400,
	"error": "Bad Request",
	"message": "Дни с ID cm4day999 не найдены в данной подкатегории"
}
```

```json
{
	"statusCode": 400,
	"error": "Bad Request",
	"message": "Этот план питания уже назначен данному клиенту"
}
```

**403 Forbidden** - Нет доступа к клиенту:

```json
{
	"statusCode": 403,
	"error": "Forbidden",
	"message": "Вы не работаете с этим клиентом"
}
```

**404 Not Found** - Подкатегория не найдена:

```json
{
	"statusCode": 404,
	"error": "Not Found",
	"message": "Подкатегория не найдена или не принадлежит вам"
}
```

### Бизнес-логика

**Проверки при назначении:**

1. Связь тренер-клиент со статусом `ACCEPTED`
2. Подкатегория принадлежит тренеру
3. Указанные дни существуют в подкатегории
4. План еще не назначен этому клиенту

**Особенности:**

- Пустой массив `dayIds` означает назначение **всех дней** из подкатегории
- Непустой массив - назначаются только **указанные дни**
- Один план может быть назначен клиенту только один раз

**Примечание:** Эндпоинты для работы с днями (`NutritionDay`) будут реализованы позже (EPIC 7).

---

### Безопасность

- Публичный эндпоинт `/all` не раскрывает приватную информацию (email, phone)
- Тренеры видят всех клиентов, но не могут изменять их данные
- Избранное - локальная функция тренера, не влияет на клиента
