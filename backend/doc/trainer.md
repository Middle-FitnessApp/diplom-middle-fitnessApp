# Trainer API - Документация

API для работы с тренерами и управления клиентами.

**Base URL:** `/api/trainer`

---

## Оглавление

- [Получение всех тренеров](#получение-всех-тренеров)
- [Получение клиентов тренера](#получение-клиентов-тренера)
- [Добавить/убрать клиента в избранное](#добавитьубрать-клиента-в-избранное)

---

## Получение всех тренеров

Получает список всех зарегистрированных тренеров для публичного просмотра.

**Endpoint:** `GET /api/trainer/all`

**Права доступа:** `PUBLIC` (не требуется авторизация)

### Успешный ответ (200 OK)

```json
{
	"trainers": [
		{
			"id": "cm4xyz789ghi012",
			"name": "Алексей Смирнов",
			"photo": "/uploads/photos/trainer1.jpg",
			"bio": "Сертифицированный тренер с 10-летним опытом",
			"telegram": "@alextrainer",
			"whatsapp": "+79997654321",
			"instagram": "alex_fitness"
		},
		{
			"id": "cm4def456jkl789",
			"name": "Мария Иванова",
			"photo": "/uploads/photos/trainer2.jpg",
			"bio": "Специалист по йоге и стретчингу",
			"telegram": "@maria_yoga",
			"whatsapp": null,
			"instagram": "maria_yoga_pro"
		}
	]
}
```

### Описание полей ответа

- `id` - уникальный идентификатор тренера
- `name` - имя тренера
- `photo` - путь к фото профиля
- `bio` - биография тренера
- `telegram` - username в Telegram (может быть `null`)
- `whatsapp` - номер WhatsApp (может быть `null`)
- `instagram` - username в Instagram (может быть `null`)

### Сортировка

Тренеры отсортированы по имени в алфавитном порядке.

### Примечания

- Этот эндпоинт **не требует авторизации** - доступен для всех пользователей
- Возвращает только базовую публичную информацию о тренерах
- Email и телефон тренеров **не возвращаются** для защиты приватности

---

## Получение клиентов тренера

Получает список всех клиентов с информацией о том, какие из них в избранном у тренера.

**Endpoint:** `GET /api/trainer/clients`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Успешный ответ (200 OK)

```json
{
	"clients": [
		{
			"id": "cm4abc123def456",
			"email": "ivan@example.com",
			"name": "Иван Петров",
			"age": 25,
			"phone": "+79991234567",
			"photo": "/uploads/photos/client1.jpg",
			"role": "CLIENT",
			"isFavorite": true
		},
		{
			"id": "cm4ghi789jkl012",
			"email": "maria@example.com",
			"name": "Мария Сидорова",
			"age": 30,
			"phone": "+79997654321",
			"photo": "/uploads/default/user.png",
			"role": "CLIENT",
			"isFavorite": false
		}
	]
}
```

### Описание полей ответа

- `id` - уникальный идентификатор клиента
- `email` - email клиента
- `name` - имя клиента
- `age` - возраст
- `phone` - номер телефона
- `photo` - путь к фото профиля
- `role` - роль (всегда `CLIENT`)
- `isFavorite` - `true` если клиент в избранном у этого тренера, `false` если нет

### Примечания

- Возвращает **всех клиентов** в системе
- Для каждого клиента проверяется связь с текущим тренером
- Поле `isFavorite` показывает, добавлен ли клиент в избранное
- В будущем будет фильтрация только по клиентам тренера (после реализации системы приглашений)

### Ошибки

- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров

---

## Добавить/убрать клиента в избранное

Переключает статус "избранное" для клиента.

**Endpoint:** `PATCH /api/trainer/clients/:clientId/favorite`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание          |
| -------- | ------ | ----------------- |
| clientId | string | ID клиента (CUID) |

### Примеры запросов

```bash
# Добавить/убрать клиента в избранное
curl -X PATCH http://localhost:3000/api/trainer/clients/cm4abc123def456/favorite \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

**Когда клиент добавлен в избранное:**

```json
{
	"message": "Клиент добавлен в избранное",
	"isFavorite": true
}
```

**Когда клиент убран из избранного:**

```json
{
	"message": "Клиент убран из избранного",
	"isFavorite": false
}
```

### Описание

Эндпоинт работает как переключатель (toggle):

1. Если связь `TrainerClient` не существует - создается с `isFavorite: true`
2. Если связь существует с `isFavorite: false` - переключается на `true`
3. Если связь существует с `isFavorite: true` - переключается на `false`

### Ошибки

- **400 Bad Request** - Некорректный формат ID клиента
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров
- **404 Not Found** - Клиент не найден

---

## Модель TrainerClient

Связь между тренером и клиентом с системой приглашений.

### Структура модели

```typescript
{
	id: string // CUID
	trainerId: string // ID тренера
	clientId: string // ID клиента
	status: TrainerClientStatus // Статус приглашения
	isFavorite: boolean // Избранный клиент
	acceptedAt: Date | null // Дата принятия приглашения
	createdAt: Date // Дата создания связи
	updatedAt: Date // Дата обновления
}
```

### Статусы приглашений (TrainerClientStatus)

| Статус   | Описание                               |
| -------- | -------------------------------------- |
| PENDING  | Приглашение отправлено, ожидает ответа |
| ACCEPTED | Приглашение принято тренером           |
| REJECTED | Приглашение отклонено тренером         |

### Правила работы системы приглашений

1. **Клиент отправляет приглашения:**

   - Может отправить приглашения нескольким тренерам
   - Все приглашения создаются со статусом `PENDING`

2. **Тренер принимает приглашение:**

   - Статус меняется на `ACCEPTED`
   - Устанавливается `acceptedAt` (текущая дата)
   - **Все остальные приглашения от этого клиента автоматически отклоняются** (статус `REJECTED`)

3. **Тренер отклоняет приглашение:**

   - Статус меняется на `REJECTED`
   - Клиент может найти другого тренера

4. **Ограничение:**
   - У клиента может быть только **один активный тренер** (одна связь со статусом `ACCEPTED`)

### Unique Constraint

Модель имеет составной уникальный ключ:

```prisma
@@unique([clientId, trainerId])
```

Это означает, что:

- Один клиент не может отправить несколько приглашений одному тренеру
- Уникальность проверяется по паре `(clientId, trainerId)`

---

## Примечания

### Текущая реализация

На данный момент реализованы эндпоинты:

- ✅ Просмотр всех тренеров (PUBLIC)
- ✅ Просмотр клиентов тренера
- ✅ Добавление/удаление клиентов в избранное

### В разработке (EPIC 4)

Система приглашений (12 задач):

- 4.2: Просмотр профиля конкретного тренера
- 4.3: Отправка приглашения тренеру от клиента
- 4.4: Получение списка приглашений для тренера
- 4.5: Принятие приглашения
- 4.6: Отклонение приглашения
- 4.7-4.12: Дополнительные функции

### Безопасность

- Публичный эндпоинт `/all` не раскрывает приватную информацию (email, phone)
- Тренеры видят всех клиентов, но не могут изменять их данные
- Избранное - локальная функция тренера, не влияет на клиента
