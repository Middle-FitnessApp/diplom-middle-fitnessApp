# Trainer API - Документация

API для работы с тренерами и управления клиентами.

**Base URL:** `/api/trainer`

---

## Оглавление

- [Получение всех тренеров](#получение-всех-тренеров)
- [Получение профиля конкретного тренера](#получение-профиля-конкретного-тренера)
- [Получение приглашений для тренера](#получение-приглашений-для-тренера)
- [Принятие приглашения от клиента](#принятие-приглашения-от-клиента)
- [Отклонение приглашения от клиента](#отклонение-приглашения-от-клиента)
- [Получение клиентов тренера](#получение-клиентов-тренера)
- [Добавить/убрать клиента в избранное](#добавитьубрать-клиента-в-избранное)

---

## Получение всех тренеров

Получает список всех зарегистрированных тренеров для публичного просмотра.

**Endpoint:** `GET /api/trainer/all`

**Права доступа:** `PUBLIC` (не требуется авторизация)

### Успешный ответ (200 OK)

```json
{
	"trainers": [
		{
			"id": "cm4xyz789ghi012",
			"name": "Алексей Смирнов",
			"photo": "/uploads/photos/trainer1.jpg",
			"bio": "Сертифицированный тренер с 10-летним опытом",
			"telegram": "@alextrainer",
			"whatsapp": "+79997654321",
			"instagram": "alex_fitness"
		},
		{
			"id": "cm4def456jkl789",
			"name": "Мария Иванова",
			"photo": "/uploads/photos/trainer2.jpg",
			"bio": "Специалист по йоге и стретчингу",
			"telegram": "@maria_yoga",
			"whatsapp": null,
			"instagram": "maria_yoga_pro"
		}
	]
}
```

### Описание полей ответа

- `id` - уникальный идентификатор тренера
- `name` - имя тренера
- `photo` - путь к фото профиля
- `bio` - биография тренера
- `telegram` - username в Telegram (может быть `null`)
- `whatsapp` - номер WhatsApp (может быть `null`)
- `instagram` - username в Instagram (может быть `null`)

### Сортировка

Тренеры отсортированы по имени в алфавитном порядке.

### Примечания

- Этот эндпоинт **не требует авторизации** - доступен для всех пользователей
- Возвращает только базовую публичную информацию о тренерах
- Email и телефон тренеров **не возвращаются** для защиты приватности

---

## Получение профиля конкретного тренера

Получает полную информацию о конкретном тренере. Если пользователь авторизован как клиент, добавляются дополнительные поля о статусе приглашения.

**Endpoint:** `GET /api/trainer/:id`

**Права доступа:** `PUBLIC` (авторизация опциональна)

**Headers (опционально):**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание          |
| -------- | ------ | ----------------- |
| id       | string | ID тренера (CUID) |

### Примеры запросов

**Без авторизации:**

```bash
curl -X GET http://localhost:3000/api/trainer/cm4xyz789ghi012
```

**С авторизацией (CLIENT):**

```bash
curl -X GET http://localhost:3000/api/trainer/cm4xyz789ghi012 \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

**Для неавторизованного пользователя:**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z"
	}
}
```

**Для авторизованного клиента (без приглашения):**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"inviteStatus": null,
		"isMyTrainer": false
	}
}
```

**Для авторизованного клиента (с приглашением PENDING):**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"inviteStatus": "PENDING",
		"isMyTrainer": false
	}
}
```

**Для авторизованного клиента (с приглашением ACCEPTED):**

```json
{
	"trainer": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"photo": "/uploads/photos/trainer1.jpg",
		"age": 30,
		"bio": "Сертифицированный тренер с 10-летним опытом. Специализация: силовые тренировки, функциональный тренинг.",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"inviteStatus": "ACCEPTED",
		"isMyTrainer": true
	}
}
```

### Описание полей ответа

**Базовые поля (для всех пользователей):**

- `id` - уникальный идентификатор тренера
- `name` - имя тренера
- `photo` - путь к фото профиля
- `age` - возраст тренера
- `bio` - биография и специализация
- `telegram` - username в Telegram (может быть `null`)
- `whatsapp` - номер WhatsApp (может быть `null`)
- `instagram` - username в Instagram (может быть `null`)
- `createdAt` - дата регистрации тренера

**Дополнительные поля (только для авторизованных клиентов):**

- `inviteStatus` - статус приглашения (`PENDING` | `ACCEPTED` | `REJECTED` | `null`)
- `isMyTrainer` - `true` если это текущий тренер клиента (статус `ACCEPTED`), иначе `false`

### Логика работы

1. **Без авторизации:**

   - Возвращается только базовая публичная информация
   - Поля `inviteStatus` и `isMyTrainer` отсутствуют

2. **С авторизацией (CLIENT):**

   - Проверяется наличие связи `TrainerClient` между клиентом и тренером
   - Если связь существует - возвращается её статус
   - Если связи нет - `inviteStatus: null`, `isMyTrainer: false`

3. **С авторизацией (TRAINER):**
   - Тренеры не получают дополнительные поля
   - Возвращается только базовая информация

### Ошибки

- **404 Not Found** - Тренер не найден или пользователь не является тренером

### Примечания

- Эндпоинт **публичный** - не требует обязательной авторизации
- Авторизация опциональна и влияет только на наличие дополнительных полей
- Невалидный токен игнорируется - эндпоинт продолжает работу как публичный
- Email и телефон тренера **не возвращаются** для защиты приватности

---

## Получение приглашений для тренера

Получает список клиентов, отправивших приглашения тренеру. Поддерживает фильтрацию по статусу и пагинацию.

**Endpoint:** `GET /api/trainer/invites`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Query параметры

| Параметр | Тип    | По умолчанию | Описание                                              |
| -------- | ------ | ------------ | ----------------------------------------------------- |
| status   | string | `PENDING`    | Статус приглашений: `PENDING`, `ACCEPTED`, `REJECTED` |
| page     | number | `1`          | Номер страницы (минимум 1)                            |
| limit    | number | `10`         | Количество элементов на странице (от 1 до 100)        |

### Примеры запросов

**Получить ожидающие приглашения (по умолчанию):**

```bash
curl -X GET http://localhost:3000/api/trainer/invites \
  -H "Authorization: Bearer <access_token>"
```

**Получить принятые приглашения (текущие клиенты):**

```bash
curl -X GET "http://localhost:3000/api/trainer/invites?status=ACCEPTED" \
  -H "Authorization: Bearer <access_token>"
```

**Получить отклоненные приглашения со второй страницы:**

```bash
curl -X GET "http://localhost:3000/api/trainer/invites?status=REJECTED&page=2&limit=20" \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"invites": [
		{
			"id": "cm4xyz123abc456",
			"status": "PENDING",
			"createdAt": "2024-12-01T10:00:00.000Z",
			"client": {
				"id": "cm4abc789def012",
				"name": "Анна Смирнова",
				"photo": "/uploads/photos/client1.jpg",
				"age": 25,
				"goal": "Похудение"
			}
		},
		{
			"id": "cm4def456ghi789",
			"status": "PENDING",
			"createdAt": "2024-12-01T09:30:00.000Z",
			"client": {
				"id": "cm4ghi012jkl345",
				"name": "Иван Петров",
				"photo": null,
				"age": 30,
				"goal": "Набор мышечной массы"
			}
		}
	]
}
```

### Описание полей ответа

- `id` - уникальный идентификатор приглашения (TrainerClient.id)
- `status` - статус приглашения (`PENDING` | `ACCEPTED` | `REJECTED`)
- `createdAt` - дата отправки приглашения
- `client` - информация о клиенте:
  - `id` - ID клиента
  - `name` - имя клиента
  - `photo` - фото профиля (может быть `null`)
  - `age` - возраст клиента
  - `goal` - цель тренировок (может быть `null`)

### Сортировка

Приглашения отсортированы по дате создания в обратном порядке (новые первыми).

### Пагинация

Пример использования:

- `page=1&limit=10` - первые 10 приглашений
- `page=2&limit=10` - приглашения с 11 по 20
- `page=3&limit=20` - приглашения с 41 по 60

### Примечания

- По умолчанию возвращаются только **PENDING** приглашения (ожидающие ответа)
- Для просмотра текущих клиентов используйте `status=ACCEPTED`
- Максимальный лимит на странице - 100 элементов
- Если приглашений нет - возвращается пустой массив `[]`

### Ошибки

- **400 Bad Request** - Некорректные query параметры (неверный статус, page < 1, limit вне диапазона)
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров

---

## Принятие приглашения от клиента

Тренер принимает приглашение от клиента, устанавливает связь и автоматически отклоняет все остальные приглашения этого клиента.

**Endpoint:** `POST /api/trainer/invites/:id/accept`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание              |
| -------- | ------ | --------------------- |
| id       | string | ID приглашения (CUID) |

### Примеры запросов

```bash
curl -X POST http://localhost:3000/api/trainer/invites/cm4xyz123abc456/accept \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"message": "Вы приняли клиента в работу",
	"client": {
		"id": "cm4abc789def012",
		"name": "Анна Смирнова",
		"photo": "/uploads/photos/client1.jpg",
		"isFavorite": false
	}
}
```

### Описание полей ответа

- `message` - подтверждающее сообщение
- `client` - информация о принятом клиенте:
  - `id` - ID клиента
  - `name` - имя клиента
  - `photo` - фото профиля (может быть `null`)
  - `isFavorite` - флаг избранного (по умолчанию `false`)

### Логика работы

1. **Проверка приглашения:**

   - Приглашение должно существовать
   - Должно быть предназначено текущему тренеру
   - Должно быть в статусе `PENDING`

2. **Проверка клиента:**

   - У клиента НЕ должно быть активного тренера (другой связи со статусом `ACCEPTED`)
   - Если есть → возвращается ошибка 409 Conflict

3. **Принятие приглашения (транзакция):**
   - Текущее приглашение: статус → `ACCEPTED`, устанавливается `acceptedAt`
   - Все остальные приглашения этого клиента: статус → `REJECTED`
   - Гарантируется атомарность операции

### Ошибки

**400 Bad Request** - Приглашение уже обработано

```json
{
	"statusCode": 400,
	"message": "Приглашение уже обработано"
}
```

**403 Forbidden** - Приглашение предназначено другому тренеру

```json
{
	"statusCode": 403,
	"message": "Это приглашение предназначено другому тренеру"
}
```

**404 Not Found** - Приглашение не найдено

```json
{
	"statusCode": 404,
	"message": "Приглашение не найдено"
}
```

**409 Conflict** - Клиент уже работает с другим тренером

```json
{
	"statusCode": 409,
	"message": "Клиент уже работает с другим тренером"
}
```

### Примечания

- После принятия приглашения у клиента может быть только **один активный тренер**
- Все остальные PENDING приглашения клиента автоматически отклоняются
- Операция выполняется в транзакции для обеспечения целостности данных
- Флаг `isFavorite` по умолчанию `false`, тренер может изменить его позже

---

## Отклонение приглашения от клиента

Тренер отклоняет приглашение от клиента. Клиент сможет повторно отправить приглашение позже.

**Endpoint:** `POST /api/trainer/invites/:id/reject`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание              |
| -------- | ------ | --------------------- |
| id       | string | ID приглашения (CUID) |

### Примеры запросов

```bash
curl -X POST http://localhost:3000/api/trainer/invites/cm4xyz123abc456/reject \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"message": "Приглашение отклонено"
}
```

### Логика работы

1. **Проверка приглашения:**

   - Приглашение должно существовать
   - Должно быть предназначено текущему тренеру
   - Должно быть в статусе `PENDING`

2. **Отклонение:**
   - Статус приглашения изменяется на `REJECTED`
   - Клиент может повторно отправить приглашение этому же тренеру позже

### Ошибки

**400 Bad Request** - Приглашение уже обработано

```json
{
	"statusCode": 400,
	"message": "Приглашение уже обработано"
}
```

**403 Forbidden** - Приглашение предназначено другому тренеру

```json
{
	"statusCode": 403,
	"message": "Это приглашение предназначено другому тренеру"
}
```

**404 Not Found** - Приглашение не найдено

```json
{
	"statusCode": 404,
	"message": "Приглашение не найдено"
}
```

### Примечания

- После отклонения клиент может отправить новое приглашение
- Отклонение не влияет на другие приглашения клиента к другим тренерам
- Операция простая и не требует транзакции

---

## Получение клиентов тренера

Получает список всех клиентов с информацией о том, какие из них в избранном у тренера.

**Endpoint:** `GET /api/trainer/clients`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Успешный ответ (200 OK)

```json
{
	"clients": [
		{
			"id": "cm4abc123def456",
			"email": "ivan@example.com",
			"name": "Иван Петров",
			"age": 25,
			"phone": "+79991234567",
			"photo": "/uploads/photos/client1.jpg",
			"role": "CLIENT",
			"isFavorite": true
		},
		{
			"id": "cm4ghi789jkl012",
			"email": "maria@example.com",
			"name": "Мария Сидорова",
			"age": 30,
			"phone": "+79997654321",
			"photo": "/uploads/default/user.png",
			"role": "CLIENT",
			"isFavorite": false
		}
	]
}
```

### Описание полей ответа

- `id` - уникальный идентификатор клиента
- `email` - email клиента
- `name` - имя клиента
- `age` - возраст
- `phone` - номер телефона
- `photo` - путь к фото профиля
- `role` - роль (всегда `CLIENT`)
- `isFavorite` - `true` если клиент в избранном у этого тренера, `false` если нет

### Примечания

- Возвращает **всех клиентов** в системе
- Для каждого клиента проверяется связь с текущим тренером
- Поле `isFavorite` показывает, добавлен ли клиент в избранное
- В будущем будет фильтрация только по клиентам тренера (после реализации системы приглашений)

### Ошибки

- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров

---

## Добавить/убрать клиента в избранное

Переключает статус "избранное" для клиента.

**Endpoint:** `PATCH /api/trainer/clients/:clientId/favorite`

**Права доступа:** `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание          |
| -------- | ------ | ----------------- |
| clientId | string | ID клиента (CUID) |

### Примеры запросов

```bash
# Добавить/убрать клиента в избранное
curl -X PATCH http://localhost:3000/api/trainer/clients/cm4abc123def456/favorite \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

**Когда клиент добавлен в избранное:**

```json
{
	"message": "Клиент добавлен в избранное",
	"isFavorite": true
}
```

**Когда клиент убран из избранного:**

```json
{
	"message": "Клиент убран из избранного",
	"isFavorite": false
}
```

### Описание

Эндпоинт работает как переключатель (toggle):

1. Если связь `TrainerClient` не существует - создается с `isFavorite: true`
2. Если связь существует с `isFavorite: false` - переключается на `true`
3. Если связь существует с `isFavorite: true` - переключается на `false`

### Ошибки

- **400 Bad Request** - Некорректный формат ID клиента
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров
- **404 Not Found** - Клиент не найден

---

## Модель TrainerClient

Связь между тренером и клиентом с системой приглашений.

### Структура модели

```typescript
{
	id: string // CUID
	trainerId: string // ID тренера
	clientId: string // ID клиента
	status: TrainerClientStatus // Статус приглашения
	isFavorite: boolean // Избранный клиент
	acceptedAt: Date | null // Дата принятия приглашения
	createdAt: Date // Дата создания связи
	updatedAt: Date // Дата обновления
}
```

### Статусы приглашений (TrainerClientStatus)

| Статус   | Описание                               |
| -------- | -------------------------------------- |
| PENDING  | Приглашение отправлено, ожидает ответа |
| ACCEPTED | Приглашение принято тренером           |
| REJECTED | Приглашение отклонено тренером         |

### Правила работы системы приглашений

1. **Клиент отправляет приглашения:**

   - Может отправить приглашения нескольким тренерам
   - Все приглашения создаются со статусом `PENDING`

2. **Тренер принимает приглашение:**

   - Статус меняется на `ACCEPTED`
   - Устанавливается `acceptedAt` (текущая дата)
   - **Все остальные приглашения от этого клиента автоматически отклоняются** (статус `REJECTED`)

3. **Тренер отклоняет приглашение:**

   - Статус меняется на `REJECTED`
   - Клиент может найти другого тренера

4. **Ограничение:**
   - У клиента может быть только **один активный тренер** (одна связь со статусом `ACCEPTED`)

### Unique Constraint

Модель имеет составной уникальный ключ:

```prisma
@@unique([clientId, trainerId])
```

Это означает, что:

- Один клиент не может отправить несколько приглашений одному тренеру
- Уникальность проверяется по паре `(clientId, trainerId)`

---

## Примечания

### Текущая реализация

На данный момент реализованы эндпоинты:

- ✅ Просмотр всех тренеров (PUBLIC)
- ✅ Просмотр клиентов тренера
- ✅ Добавление/удаление клиентов в избранное

### В разработке (EPIC 4)

Система приглашений (12 задач):

- 4.2: Просмотр профиля конкретного тренера
- 4.3: Отправка приглашения тренеру от клиента
- 4.4: Получение списка приглашений для тренера
- 4.5: Принятие приглашения
- 4.6: Отклонение приглашения
- 4.7-4.12: Дополнительные функции

### Безопасность

- Публичный эндпоинт `/all` не раскрывает приватную информацию (email, phone)
- Тренеры видят всех клиентов, но не могут изменять их данные
- Избранное - локальная функция тренера, не влияет на клиента
