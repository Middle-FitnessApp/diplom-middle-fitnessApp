# User API - Документация

API для управления профилями пользователей (клиентов и тренеров).

**Base URL:** `/api/user`

---

## Оглавление

- [Получение информации о себе](#получение-информации-о-себе)
- [Обновление профиля клиента](#обновление-профиля-клиента)
- [Обновление профиля тренера](#обновление-профиля-тренера)
- [Отправка приглашения тренеру](#отправка-приглашения-тренеру)
- [Отмена приглашения тренеру](#отмена-приглашения-тренеру)
- [Отмена сотрудничества с тренером](#отмена-сотрудничества-с-тренером)

---

## Получение информации о себе

Получает полную информацию о текущем авторизованном пользователе.

**Endpoint:** `GET /api/user/me`

**Права доступа:** `CLIENT`, `TRAINER`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Успешный ответ (200 OK)

**Для клиента:**

```json
{
	"user": {
		"id": "cm4abc123def456",
		"name": "Иван Петров",
		"email": "ivan@example.com",
		"phone": "+79991234567",
		"photo": "/uploads/photos/user-photo.jpg",
		"age": 25,
		"role": "CLIENT",
		"goal": "Похудение",
		"restrictions": "Проблемы с коленями",
		"experience": "Новичок",
		"diet": "Без ограничений",
		"createdAt": "2025-11-20T10:30:00.000Z",
		"updatedAt": "2025-12-03T10:30:00.000Z",
		"trainer": {
			"id": "cm4xyz789ghi012",
			"name": "Алексей Смирнов",
			"photo": "/uploads/photos/trainer-photo.jpg",
			"bio": "Сертифицированный тренер с 10-летним опытом",
			"telegram": "@alextrainer",
			"whatsapp": "+79997654321",
			"instagram": "alex_fitness"
		}
	}
}
```

**Если у клиента нет тренера:**

```json
{
	"user": {
		"id": "cm4abc123def456",
		"name": "Иван Петров",
		"email": "ivan@example.com",
		"phone": "+79991234567",
		"photo": "/uploads/photos/user-photo.jpg",
		"age": 25,
		"role": "CLIENT",
		"goal": "Похудение",
		"restrictions": "Проблемы с коленями",
		"experience": "Новичок",
		"diet": "Без ограничений",
		"createdAt": "2025-11-20T10:30:00.000Z",
		"updatedAt": "2025-12-03T10:30:00.000Z",
		"trainer": null
	}
}
```

**Для тренера:**

```json
{
	"user": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"email": "alex@example.com",
		"phone": "+79997654321",
		"photo": "/uploads/photos/trainer-photo.jpg",
		"age": 30,
		"role": "TRAINER",
		"telegram": "@alextrainer",
		"whatsapp": "+79997654321",
		"instagram": "alex_fitness",
		"bio": "Сертифицированный тренер с 10-летним опытом",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"updatedAt": "2025-12-01T15:00:00.000Z"
	}
}
```

### Описание полей ответа

**Общие поля:**

- `id` - уникальный идентификатор
- `name` - имя пользователя
- `email` - email (если указан)
- `phone` - телефон (если указан)
- `photo` - основное фото профиля
- `age` - возраст
- `role` - роль (`CLIENT` или `TRAINER`)
- `createdAt` - дата регистрации
- `updatedAt` - дата последнего обновления

**Поля клиента (CLIENT):**

- `goal` - цель тренировок (может быть `null`)
- `restrictions` - ограничения по здоровью (может быть `null`)
- `experience` - опыт тренировок (может быть `null`)
- `diet` - особенности питания (может быть `null`)
- `trainer` - информация о назначенном тренере (может быть `null` если тренер не назначен):
  - `id` - ID тренера
  - `name` - имя тренера
  - `photo` - фото профиля тренера
  - `bio` - биография тренера
  - `telegram` - username в Telegram (может быть `null`)
  - `whatsapp` - номер WhatsApp (может быть `null`)
  - `instagram` - username в Instagram (может быть `null`)

**Поля тренера (TRAINER):**

- `telegram` - username в Telegram (может быть `null`)
- `whatsapp` - номер WhatsApp (может быть `null`)
- `instagram` - username в Instagram (может быть `null`)
- `bio` - биография (может быть `null`)

### Логика работы

**Для клиента:**

- Автоматически ищется запись `TrainerClient` со статусом `ACCEPTED`
- Если найдена - возвращается информация о тренере
- Если не найдена - поле `trainer` будет `null`
- У клиента может быть только один активный тренер

**Для тренера:**

- Возвращается полная информация профиля
- Включает контактные данные и биографию

### Ошибки

**401 Unauthorized** - Отсутствует или недействителен access token

```json
{
	"statusCode": 401,
	"message": "Unauthorized"
}
```

**404 Not Found** - Пользователь не найден

```json
{
	"statusCode": 404,
	"message": "Пользователь не найден"
}
```

### Примечания

- Эндпоинт доступен как клиентам, так и тренерам
- Возвращаемые поля зависят от роли пользователя
- Для клиентов автоматически подгружается информация о назначенном тренере
- Информация о тренере включает только публичные данные (без email и phone)

---

## Обновление профиля клиента

Обновляет данные профиля клиента.

**Endpoint:** `PUT /api/user/client/profile`

**Права доступа:** `CLIENT`

**Content-Type:** `multipart/form-data` (если загружается фото) или `application/json`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры запроса

| Поле         | Тип    | Обязательное | Описание                            |
| ------------ | ------ | ------------ | ----------------------------------- |
| name         | string | ❌           | Имя пользователя                    |
| email        | string | ❌           | Email (уникальный)                  |
| phone        | string | ❌           | Телефон в формате +7XXXXXXXXXX      |
| age          | number | ❌           | Возраст                             |
| photo        | file   | ❌           | Основное фото профиля (макс. 500KB) |
| goal         | string | ❌           | Цель тренировок                     |
| restrictions | string | ❌           | Ограничения по здоровью             |
| experience   | string | ❌           | Опыт тренировок                     |
| diet         | string | ❌           | Особенности питания                 |

### Примеры запросов

**Обновление с фото (multipart/form-data):**

```bash
curl -X PUT http://localhost:3000/api/user/client/profile \
  -H "Authorization: Bearer <access_token>" \
  -F "name=Иван Петров Обновленный" \
  -F "age=26" \
  -F "goal=Набор мышечной массы" \
  -F "photo=@new-photo.jpg"
```

**Обновление без фото (application/json):**

```json
{
	"name": "Иван Петров",
	"age": 26,
	"goal": "Набор мышечной массы",
	"experience": "Средний уровень"
}
```

### Успешный ответ (200 OK)

```json
{
	"message": "Профиль клиента успешно обновлён",
	"user": {
		"id": "cm4abc123def456",
		"name": "Иван Петров",
		"email": "ivan@example.com",
		"phone": "+79991234567",
		"photo": "/uploads/photos/new-photo.jpg",
		"age": 26,
		"role": "CLIENT",
		"goal": "Набор мышечной массы",
		"restrictions": "Проблемы с коленями",
		"experience": "Средний уровень",
		"diet": "Без ограничений",
		"photoFront": "/uploads/photos/front-abc123.jpg",
		"photoSide": "/uploads/photos/side-abc123.jpg",
		"photoBack": "/uploads/photos/back-abc123.jpg",
		"createdAt": "2025-11-20T10:30:00.000Z",
		"updatedAt": "2025-12-03T14:20:00.000Z"
	}
}
```

### Ошибки

- **400 Bad Request** - Некорректные данные
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для клиентов
- **409 Conflict** - Email или телефон уже используется другим пользователем
- **400 Bad Request** - Файл фото превышает 500KB

---

## Обновление профиля тренера

Обновляет данные профиля тренера.

**Endpoint:** `PUT /api/user/trainer/profile`

**Права доступа:** `TRAINER`

**Content-Type:** `multipart/form-data` (если загружается фото) или `application/json`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры запроса

| Поле      | Тип    | Обязательное | Описание                            |
| --------- | ------ | ------------ | ----------------------------------- |
| name      | string | ❌           | Имя тренера                         |
| email     | string | ❌           | Email (уникальный)                  |
| phone     | string | ❌           | Телефон в формате +7XXXXXXXXXX      |
| age       | number | ❌           | Возраст                             |
| photo     | file   | ❌           | Основное фото профиля (макс. 500KB) |
| telegram  | string | ❌           | Username в Telegram                 |
| whatsapp  | string | ❌           | Номер WhatsApp                      |
| instagram | string | ❌           | Username в Instagram                |
| bio       | string | ❌           | Биография тренера                   |

### Примеры запросов

**Обновление с фото (multipart/form-data):**

```bash
curl -X PUT http://localhost:3000/api/user/trainer/profile \
  -H "Authorization: Bearer <access_token>" \
  -F "name=Алексей Смирнов" \
  -F "bio=Сертифицированный тренер с 12-летним опытом" \
  -F "photo=@new-trainer-photo.jpg"
```

**Обновление без фото (application/json):**

```json
{
	"name": "Алексей Смирнов",
	"bio": "Сертифицированный тренер с 12-летним опытом",
	"instagram": "alex_pro_fitness",
	"telegram": "@alextrainer_updated"
}
```

### Успешный ответ (200 OK)

```json
{
	"message": "Профиль тренера успешно обновлён",
	"user": {
		"id": "cm4xyz789ghi012",
		"name": "Алексей Смирнов",
		"email": "alex@example.com",
		"phone": "+79997654321",
		"photo": "/uploads/photos/new-trainer-photo.jpg",
		"age": 30,
		"role": "TRAINER",
		"telegram": "@alextrainer_updated",
		"whatsapp": "+79997654321",
		"instagram": "alex_pro_fitness",
		"bio": "Сертифицированный тренер с 12-летним опытом",
		"createdAt": "2025-10-15T08:00:00.000Z",
		"updatedAt": "2025-12-03T16:45:00.000Z"
	}
}
```

### Ошибки

- **400 Bad Request** - Некорректные данные
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для тренеров
- **409 Conflict** - Email или телефон уже используется другим пользователем
- **400 Bad Request** - Файл фото превышает 500KB

---

## Примечания

### Фотографии

- **Основное фото профиля** (`photo`) - можно обновить для обеих ролей
- **Регистрационные фото** (`photoFront`, `photoSide`, `photoBack`) - только для клиентов, устанавливаются при регистрации и **не обновляются** через этот API
- **Максимальный размер:** 500KB
- **Форматы:** JPG, PNG
- **Хранение:**
  - Development: локальная папка `uploads/photos`
  - Production: Supabase Storage (публичные URL)

### Контактные данные

- Email и телефон должны быть уникальными в системе
- При обновлении происходит проверка на конфликт с другими пользователями
- Формат телефона: `+7XXXXXXXXXX` (11 цифр с кодом страны)
- Email проверяется на корректность формата

### Обновление полей

- Все поля опциональны - можно обновить только нужные
- Поля, которые не переданы в запросе, остаются без изменений
- Пустая строка `""` не удаляет значение, а игнорируется
- Для удаления значения необходимо передать `null` (только в JSON)

### Content-Type

- Используйте `multipart/form-data` если загружаете фото
- Используйте `application/json` если обновляете только текстовые поля
- При использовании `multipart/form-data` числовые поля передаются как строки и автоматически конвертируются

---

## Отправка приглашения тренеру

Отправляет приглашение выбранному тренеру для начала работы.

**Endpoint:** `POST /api/user/client/invite-trainer`

**Права доступа:** `CLIENT`

**Content-Type:** `application/json`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры запроса

| Поле      | Тип    | Обязательное | Описание          |
| --------- | ------ | ------------ | ----------------- |
| trainerId | string | ✅           | ID тренера (CUID) |

### Пример запроса

```json
{
	"trainerId": "cm4xyz789ghi012"
}
```

### Успешный ответ (201 Created)

```json
{
	"message": "Приглашение отправлено тренеру",
	"invite": {
		"id": "cm4invite123abc",
		"trainerId": "cm4xyz789ghi012",
		"status": "PENDING",
		"createdAt": "2025-12-04T10:30:00.000Z"
	}
}
```

### Описание полей ответа

- `id` - уникальный идентификатор приглашения
- `trainerId` - ID тренера, которому отправлено приглашение
- `status` - статус приглашения (всегда `PENDING` при создании)
- `createdAt` - дата и время отправки приглашения

### Логика работы

1. **Проверка тренера:**

   - Проверяется существование пользователя с указанным ID
   - Проверяется, что это действительно тренер (роль `TRAINER`)

2. **Проверка активного тренера:**

   - Если у клиента уже есть тренер со статусом `ACCEPTED` → ошибка
   - Один клиент может работать только с одним тренером одновременно

3. **Проверка дубликатов:**

   - Если приглашение этому тренеру уже отправлено (статус `PENDING`) → ошибка
   - Если тренер ранее отклонил приглашение (статус `REJECTED`) → ошибка

4. **Лимит приглашений:**

   - Максимум 5 активных приглашений (со статусом `PENDING`) одновременно
   - Если лимит превышен → ошибка

5. **Создание приглашения:**
   - Создается запись `TrainerClient` со статусом `PENDING`
   - Тренер получит это приглашение в своем списке

### Ошибки

- **400 Bad Request** - Некорректный формат ID тренера
- **400 Bad Request** - У вас уже есть активный тренер
- **400 Bad Request** - Приглашение этому тренеру уже отправлено
- **400 Bad Request** - Тренер уже отклонил ваше приглашение
- **400 Bad Request** - Превышен лимит активных приглашений (максимум 5)
- **401 Unauthorized** - Отсутствует или недействителен access token
- **403 Forbidden** - Доступ только для клиентов
- **404 Not Found** - Тренер не найден

### Примечания

**Ограничения:**

- Клиент может отправить приглашения **нескольким тренерам** (до 5 одновременно)
- Но работать может только с **одним активным тренером**
- Когда тренер принимает приглашение → все остальные приглашения автоматически отклоняются

**Статусы приглашений:**

- `PENDING` - ожидает ответа тренера
- `ACCEPTED` - тренер принял (становится активным тренером клиента)
- `REJECTED` - тренер отклонил

**Workflow:**

1. Клиент просматривает тренеров через `GET /api/trainer/all`
2. Выбирает подходящего и отправляет приглашение
3. Тренер видит приглашение в списке (будет реализовано в следующих задачах)
4. Тренер принимает или отклоняет приглашение
5. При принятии - все остальные приглашения клиента автоматически отклоняются

---

## Отмена приглашения тренеру

Клиент может отменить отправленное приглашение до того, как тренер его примет.

**Endpoint:** `DELETE /api/user/client/invites/:id`

**Права доступа:** `CLIENT`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Параметры URL

| Параметр | Тип    | Описание              |
| -------- | ------ | --------------------- |
| id       | string | ID приглашения (CUID) |

### Примеры запросов

```bash
# Отменить приглашение
curl -X DELETE http://localhost:3000/api/user/client/invites/cm4xyz789ghi012 \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"message": "Приглашение тренеру \"Алексей Смирнов\" успешно отменено"
}
```

### Описание полей ответа

- `message` - подтверждающее сообщение с именем тренера

### Логика работы

1. **Поиск приглашения:**

   - Находится запись `TrainerClient` по ID приглашения
   - Если не найдено → ошибка 404

2. **Проверка владения:**

   - Проверяется, что приглашение принадлежит текущему клиенту
   - Если не принадлежит → ошибка 403

3. **Проверка статуса:**

   - **PENDING** → можно отменить ✅
   - **ACCEPTED** → нельзя отменить, нужно использовать `DELETE /api/client/trainer` ❌
   - **REJECTED** → уже отклонено тренером, бессмысленно отменять ❌

4. **Удаление:**
   - Запись `TrainerClient` удаляется из базы данных
   - Клиент может отправить новое приглашение этому же тренеру

### Ошибки

**400 Bad Request** - Нельзя отменить принятое приглашение

```json
{
	"statusCode": 400,
	"message": "Нельзя отменить принятое приглашение. Используйте DELETE /api/client/trainer для отмены сотрудничества"
}
```

**400 Bad Request** - Приглашение уже отклонено

```json
{
	"statusCode": 400,
	"message": "Это приглашение уже отклонено тренером"
}
```

**401 Unauthorized** - Отсутствует или недействителен access token

```json
{
	"statusCode": 401,
	"message": "Unauthorized"
}
```

**403 Forbidden** - Это не ваше приглашение

```json
{
	"statusCode": 403,
	"message": "Это не ваше приглашение"
}
```

**404 Not Found** - Приглашение не найдено

```json
{
	"statusCode": 404,
	"message": "Приглашение не найдено"
}
```

### Примечания

- Эндпоинт доступен **только клиентам**
- Можно отменить только приглашения в статусе **PENDING**
- Для отмены принятого приглашения (статус **ACCEPTED**) используйте другой эндпоинт: `DELETE /api/client/trainer`
- После отмены приглашения можно отправить новое этому же тренеру
- Отмена приглашения **необратима** - запись удаляется из базы

### Различия между эндпоинтами отмены

| Эндпоинт                     | Статус   | Что удаляется         | Когда использовать       |
| ---------------------------- | -------- | --------------------- | ------------------------ |
| `DELETE /client/invites/:id` | PENDING  | Только приглашение    | Передумали приглашать    |
| `DELETE /client/trainer`     | ACCEPTED | Связь + планы питания | Разорвать сотрудничество |

---

## Отмена сотрудничества с тренером

Клиент может отменить сотрудничество с текущим тренером. При этом удаляется связь и все планы питания, назначенные этим тренером.

**Endpoint:** `DELETE /api/user/client/trainer`

**Права доступа:** `CLIENT`

**Headers:**

```
Authorization: Bearer <access_token>
```

### Примеры запросов

```bash
# Отменить сотрудничество с тренером
curl -X DELETE http://localhost:3000/api/user/client/trainer \
  -H "Authorization: Bearer <access_token>"
```

### Успешный ответ (200 OK)

```json
{
	"message": "Сотрудничество с тренером \"Алексей Смирнов\" успешно отменено",
	"deletedNutritionPlans": 3
}
```

### Описание полей ответа

- `message` - подтверждающее сообщение с именем тренера
- `deletedNutritionPlans` - количество удаленных планов питания

### Логика работы

1. **Поиск активного тренера:**

   - Находится запись `TrainerClient` со статусом `ACCEPTED` для данного клиента
   - Если активного тренера нет → ошибка 404

2. **Поиск планов питания:**

   - Находятся все `ClientNutritionPlan`, назначенные этим тренером
   - Связь определяется через цепочку: `ClientNutritionPlan` → `NutritionSubcategory` → `NutritionCategory` → `trainer`

3. **Удаление данных (транзакция):**

   - Удаляется связь `TrainerClient` (сотрудничество)
   - Удаляются все найденные планы питания
   - Операции выполняются атомарно

4. **Что сохраняется:**

   - **Комментарии к отчетам прогресса** - остаются и продолжают отображаться
   - **Отчеты о прогрессе** - сохраняются со всеми замерами и фотографиями
   - История взаимодействия с тренером

5. **После отмены:**
   - Клиент может снова отправлять приглашения любым тренерам
   - Старая запись `TrainerClient` полностью удаляется
   - Клиент может пригласить того же тренера снова

### Ошибки

**401 Unauthorized** - Отсутствует или недействителен access token

```json
{
	"statusCode": 401,
	"message": "Unauthorized"
}
```

**403 Forbidden** - Доступ только для клиентов

```json
{
	"statusCode": 403,
	"message": "Доступ запрещен"
}
```

**404 Not Found** - У вас нет активного тренера

```json
{
	"statusCode": 404,
	"message": "У вас нет активного тренера"
}
```

### Примечания

- Эндпоинт доступен **только клиентам**
- Можно отменить сотрудничество в любой момент
- Удаляются **только планы питания**, назначенные этим тренером
- **Комментарии к отчетам остаются** - это важная история взаимодействия
- После отмены клиент может работать с другим тренером
- Операция **необратима** - данные планов питания будут удалены
- Транзакция гарантирует целостность данных при удалении
