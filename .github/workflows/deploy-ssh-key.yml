name: Deploy Backend to Timeweb (SSH Key)

on:
  pull_request:
    types: [closed]
    branches:
      - development

jobs:
  deploy:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ PR –±—ã–ª –æ–¥–æ–±—Ä–µ–Ω –∏ —Å–º–µ—Ä–∂–µ–Ω
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/fitness-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/fitness-backend:${{ github.run_number }}
          no-cache: true

      - name: Deploy to Timeweb VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: root
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          script: |
            echo "üîÑ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ Docker –æ–±—Ä–∞–∑–∞..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/fitness-backend:${{ github.run_number }}

            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker stop fitness-backend || true
            docker rm fitness-backend || true

            echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker run -d \
              --name fitness-backend \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file /root/fitness-backend.env \
              ${{ secrets.DOCKER_USERNAME }}/fitness-backend:${{ github.run_number }}

            echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker —Ä–µ—Å—É—Ä—Å–æ–≤..."
            docker system prune -f

            echo "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≤–µ—Ä—Å–∏–∏)..."
            docker images ${{ secrets.DOCKER_USERNAME }}/fitness-backend --format "{{.Tag}}" | grep -E '^[0-9]+$' | sort -rn | tail -n +4 | xargs -r -I {} docker rmi ${{ secrets.DOCKER_USERNAME }}/fitness-backend:{} || true

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"

            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
            docker ps | grep fitness-backend

            echo "üìù –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            sleep 3

            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
            docker logs --tail 30 fitness-backend
