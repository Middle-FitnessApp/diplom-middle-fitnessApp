# ============================================
# Deploy - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
# ============================================
# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ ĞŸĞĞ¡Ğ›Ğ• Ğ¼ĞµÑ€Ğ¶Ğ° PR Ğ² development
# Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ Backend + Frontend

name: ğŸš€ Deploy to Server

on:
  pull_request:
    types: [closed]
    branches:
      - development

jobs:
  deploy:
    name: ğŸš€ Build & Deploy
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞµÑĞ»Ğ¸ PR Ğ±Ñ‹Ğ» ÑĞ¼ĞµÑ€Ğ¶ĞµĞ½ (Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Backend
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ–¥ï¸ Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/fitness-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/fitness-backend:${{ github.run_number }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Frontend
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ¨ Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/fitness-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/fitness-frontend:${{ github.run_number }}
          build-args: |
            VITE_API_URL=${{ secrets.API_URL }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Deploy to Timeweb VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: root
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ Ğ”Ğ•ĞŸĞ›ĞĞ™ v${{ github.run_number }}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # --- Backend ---
            echo ""
            echo "ğŸ–¥ï¸ Backend..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/fitness-backend:${{ github.run_number }}
            docker stop fitness-backend || true
            docker rm fitness-backend || true
            docker run -d \
              --name fitness-backend \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file /root/fitness-backend.env \
              ${{ secrets.DOCKER_USERNAME }}/fitness-backend:${{ github.run_number }}

            # --- Frontend ---
            echo ""
            echo "ğŸ¨ Frontend..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/fitness-frontend:${{ github.run_number }}
            docker stop fitness-frontend || true
            docker rm fitness-frontend || true
            docker run -d \
              --name fitness-frontend \
              --restart unless-stopped \
              -p 80:80 \
              ${{ secrets.DOCKER_USERNAME }}/fitness-frontend:${{ github.run_number }}

            # --- ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ---
            echo ""
            echo "ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²..."
            docker system prune -f
            docker images ${{ secrets.DOCKER_USERNAME }}/fitness-backend --format "{{.Tag}}" | grep -E '^[0-9]+$' | sort -rn | tail -n +4 | xargs -r -I {} docker rmi ${{ secrets.DOCKER_USERNAME }}/fitness-backend:{} || true
            docker images ${{ secrets.DOCKER_USERNAME }}/fitness-frontend --format "{{.Tag}}" | grep -E '^[0-9]+$' | sort -rn | tail -n +4 | xargs -r -I {} docker rmi ${{ secrets.DOCKER_USERNAME }}/fitness-frontend:{} || true

            # --- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ---
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Ğ”Ğ•ĞŸĞ›ĞĞ™ Ğ—ĞĞ’Ğ•Ğ Ğ¨ĞĞ!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

