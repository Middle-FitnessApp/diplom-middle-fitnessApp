# ============================================
# Ð Ð°Ð·Ð²Ñ‘Ñ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ â€” Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
# ============================================
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð¼ÐµÑ€Ð¶Ðµ PR Ð² Ð²ÐµÑ‚ÐºÑƒ `development` Ð¸ Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² Ñ€ÐµÐ»Ð¸Ð·Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸
# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¸ Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Backend Ð¸ Frontend

name: ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ

on:
  push:
    branches:
      - master
      - 'release/**'
      - 'release-*'
  pull_request:
    types: [closed]
    branches:
      - development

jobs:
  deploy:
    name: ðŸš€ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¹
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
        uses: actions/checkout@v4

      - name: ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Ð’Ñ…Ð¾Ð´ Ð² Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ð¡Ð±Ð¾Ñ€ÐºÐ° Backend
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ–¥ï¸ Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/fitness-backend:${{ github.sha }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ð¡Ð±Ð¾Ñ€ÐºÐ° Frontend
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸŽ¨ Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/fitness-frontend:${{ github.sha }}
          build-args: |
            VITE_API_URL=${{ secrets.API_URL }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° Timeweb VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: root
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸš€ Ð”Ð•ÐŸÐ›ÐžÐ™ ${{ github.sha }}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # --- ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ docker-compose env Ð¸ Ð¿Ð¾Ð´Ð½ÑÑ‚ÑŒ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ñ‡ÐµÑ€ÐµÐ· docker compose ---
            echo ""
            echo "ðŸŽ¯ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ /root/fitness-compose.env Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ docker compose"
            cat > /root/fitness-compose.env <<EOF
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            IMAGE_TAG=${{ github.sha }}
            EOF

            docker compose --env-file /root/fitness-compose.env -f /root/docker-compose.prod.yml pull backend frontend
            docker compose --env-file /root/fitness-compose.env -f /root/docker-compose.prod.yml up -d

            # --- ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ---
            echo ""
            echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
            # ÐÐµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¾Ð±Ñ‰ÑƒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÑƒ system prune â€” ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ñ‚Ñ€Ð¾Ð½ÑƒÑ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹.
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ SHA-Ñ‚ÐµÐ³Ð¸ (hex). ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ 2 Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ….
            docker images ${{ secrets.DOCKER_USERNAME }}/fitness-backend --format "{{.Tag}}" | grep -E '^[0-9a-f]+' | sort -r | tail -n +3 | xargs -r -I {} docker rmi ${{ secrets.DOCKER_USERNAME }}/fitness-backend:{} || true
            docker images ${{ secrets.DOCKER_USERNAME }}/fitness-frontend --format "{{.Tag}}" | grep -E '^[0-9a-f]+' | sort -r | tail -n +3 | xargs -r -I {} docker rmi ${{ secrets.DOCKER_USERNAME }}/fitness-frontend:{} || true

            # --- Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ---
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Ð”Ð•ÐŸÐ›ÐžÐ™ Ð—ÐÐ’Ð•Ð Ð¨ÐÐ!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
